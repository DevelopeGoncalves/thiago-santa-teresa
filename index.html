<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-C9RLS2SDCJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-C9RLS2SDCJ');
  </script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDV - Thiago Santa Teresa (Completo)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            terracota: '#e4593c',
            redBrown: '#a93131',
            dark: '#1a1a1a',
            cinzaEscuro: '#2d2d2d',
            cinzaClaroBg: '#f9fafb',
          }
        }
      }
    }
  </script>

  <style>
    body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    /* Ajuste para o novo layout de tela cheia */
    .app-main-content { height: calc(100vh - 60px); overflow-y: auto; }
    .sidebar-scroll { max-height: 100%; overflow:auto; } 
    
    ::-webkit-scrollbar { width:10px; height:10px; }
    ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #e4593c, #a93131); border-radius:999px; }
    ::-webkit-scrollbar-track { background: transparent; }

    .logo-bar {
      width: 120px; height: 120px; margin: 0 auto; background: #1a1a1a;
      border-radius: 50%; border: 3px solid #e4593c;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 30px rgba(228, 89, 60, 0.5);
    }
    .logo-inner {
      width: 110px; height: 110px; border-radius: 50%; border: 2px solid #ffffff;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%); padding: 10px;
    }
    .logo-stars { display: flex; gap: 3px; margin-bottom: 5px; }
    .star { color: #e4593c; font-size: 11px; }
    .logo-text { text-align: center; }
    .logo-bar-text {
      font-size: 22px; font-weight: bold; color: #e4593c;
      letter-spacing: 2px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      line-height: 1;
    }
    .logo-do-gigante {
      font-size: 12px; font-weight: bold; color: #ffffff;
      margin-top: 3px; letter-spacing: 1px;
    }
    
    /* Novo Estilo para imitar o OnChef */
    .onchef-card {
        padding: 1rem;
        border-radius: 0.75rem;
        color: white;
        font-weight: bold;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 120px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .onchef-card-title { font-size: 1.5rem; }
    .onchef-card-subtitle { font-size: 0.75rem; opacity: 0.8; }
    
    /* Estilo para Modal */
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex; justify-content: center; align-items: center;
        z-index: 50;
    }
    .modal-content {
        background: white; padding: 20px; border-radius: 12px;
        max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    /* ESTILOS DO MAPA DE MESAS */
    .mesa-card {
        aspect-ratio: 1; border-radius: 1rem; display: flex; flex-direction: column;
        align-items: center; justify-content: center; cursor: pointer;
        transition: transform 0.2s; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
  </style>
</head>
<body class="bg-slate-50">

  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useMemo, useRef } = React;

  /*************************************************
   * FUN√á√ïES DE UTILIDADE E ARMAZENAMENTO (DESACOPLADAS)
   *************************************************/

  function uid(){ return Date.now() + Math.floor(Math.random()*9999); }
  function currency(v){ return 'R$ ' + Number(v||0).toFixed(2).replace('.', ','); }
  
  function prepareForStorage(data) {
    if (Array.isArray(data)) {
        return data.map(item => {
            if (typeof item.id === 'number' || typeof item.id === 'string' && item.id.includes('.')) {
                return { ...item, id: String(item.id).replace('.', '-') };
            }
            return item;
        });
    }
    return data;
  }
  
  function prepareFromStorage(data) {
    if (Array.isArray(data)) {
        return data.map(item => ({
            ...item,
            id: typeof item.id === 'string' && item.id.includes('-') ? parseFloat(item.id.replace('-', '.')) : item.id
        }));
    }
    return data;
  }
  
  function storageGet(key, fallback=null){ 
    try {
      const data = localStorage.getItem(key);
      if (data === null) return fallback;
      
      let parsedData = JSON.parse(data);
      
      if (key === 'produtos' && parsedData) {
        parsedData = prepareFromStorage(parsedData);
      }
      
      return parsedData;
    } catch(e){ 
      console.error('Erro ao ler localStorage:', e);
      return fallback; 
    }
  }

  function storageSet(key, value){ 
    try {
      let dataToSet = value;
      if (key === 'produtos') {
        dataToSet = prepareForStorage(value); 
      }
      localStorage.setItem(key, JSON.stringify(dataToSet));
    } catch(e){
      console.error('Erro ao salvar localStorage:', e);
    }
  }
  
  function getPedidosWebPendentes() {
    try {
      const data = localStorage.getItem('pedidos_web_pendentes');
      const webPedidos = JSON.parse(data) || [];
      return webPedidos.map(p => ({ ...p, tipo: 'Venda Web', status: 'Novo - WEB', id: p.id || uid() }));
    } catch (e) {
      console.error("Erro ao ler pedidos_web_pendentes do localStorage:", e);
      return [];
    }
  }

  function calcularCusto(item, insumosMap) {
      if (!item.fichaTecnica || item.fichaTecnica.length === 0) return 0;
      
      let custoTotal = 0;
      item.fichaTecnica.forEach(insumoRef => {
          const insumoData = insumosMap[insumoRef.idInsumo];
          if (insumoData) {
              custoTotal += insumoRef.quantidade * insumoData.custoUnitario;
          }
      });
      return custoTotal;
  }
  
  function getFlatMenu(menu, insumos) {
      const insumosMap = insumos.reduce((map, i) => { map[i.id] = i; return map; }, {});

      const imageMap = {
          1: 'https://images.unsplash.com/photo-1549419130-cf2a9128f658?q=80&w=1500&h=150&fit=crop&crop=center', 
          6: 'https://images.unsplash.com/photo-1598282361730-e74f85e49c71?q=80&w=1500&h=150&fit=crop&crop=center', 
          13: 'https://images.unsplash.com/photo-1634633282298-b807a976c669?q=80&w=1500&h=150&fit=crop&crop=center', 
          16: 'https://images.unsplash.com/photo-1579227124976-5868e4c1945c?q=80&w=1500&h=150&fit=crop&crop=center', 
          23: 'https://images.unsplash.com/photo-1606822557174-874b2f155c5c?q=80&w=1500&h=150&fit=crop&crop=center', 
          28.1: 'https://images.unsplash.com/photo-1550989932-5a213e41de3b?q=80&w=1500&h=150&fit=crop&crop=center', 
          29.1: 'https://images.unsplash.com/photo-1596791221199-c454790089e1?q=80&w=1500&h=150&fit=crop&crop=center', 
          30.2: 'https://images.unsplash.com/photo-1552591630-10903347f70b?q=80&w=1500&h=150&fit=crop&crop=center', 
      };

      let flatItems = [];
      for (const category in menu) {
          menu[category].forEach(item => {
              const defaultImageUrl = `https://via.placeholder.com/400x150?text=${encodeURIComponent(item.emoji || item.nome.split(' ')[0])}`;
              const custo = calcularCusto(item, insumosMap);
              
              if (item.opcoes) {
                  item.opcoes.forEach(opcao => {
                      flatItems.push({
                          id: parseFloat(opcao.id),
                          nome: `${item.nome} (${opcao.nomeOpcao})`,
                          preco: opcao.preco,
                          emoji: item.emoji,
                          categoria: item.categoria,
                          estoque: 9999,
                          manutencao: item.manutencao || false,
                          baseId: item.id,
                          imagemUrl: imageMap[parseFloat(opcao.id)] || defaultImageUrl,
                          custoProduto: custo, 
                          fichaTecnica: item.fichaTecnica 
                      });
                  });
              } else {
                  flatItems.push({ 
                    id: item.id, 
                    nome: item.nome, 
                    preco: item.preco, 
                    emoji: item.emoji, 
                    categoria: item.categoria,
                    estoque: item.manutencao ? 0 : 9999,
                    manutencao: item.manutencao || false,
                    imagemUrl: imageMap[item.id] || defaultImageUrl,
                    custoProduto: custo, 
                    fichaTecnica: item.fichaTecnica 
                  });
              }
          });
      }
      return flatItems;
  }
  
  function darBaixaInsumos(carrinho, produtos, insumos, setInsumos) {
      const insumosMap = insumos.reduce((map, i) => { map[i.id] = {...i}; return map; }, {});
      let custoTotalVenda = 0;

      for (const item of carrinho) {
          const produtoBase = produtos.find(p => p.id === item.id);
          if (!produtoBase || !produtoBase.fichaTecnica) continue;

          for (const insumoRef of produtoBase.fichaTecnica) {
              const insumoData = insumosMap[insumoRef.idInsumo];
              if (insumoData) {
                  const quantidadeBaixa = insumoRef.quantidade * item.quantidade;
                  insumoData.estoque -= quantidadeBaixa;
                  
                  custoTotalVenda += quantidadeBaixa * insumoData.custoUnitario;
              }
          }
      }
      
      const novosInsumos = Object.values(insumosMap);
      setInsumos(novosInsumos);
      return custoTotalVenda;
  }
  
  /**********************
   * MOCK DATA
   **********************/
   
  const initialInsumos = [
      { id: 'cachaca-500', nome: 'Cacha√ßa (Garrafa)', unidade: 'ml', custoUnitario: 0.05, estoque: 10000, custoTotal: 500.00 },
      { id: 'limao-un', nome: 'Lim√£o (Unidade)', unidade: 'un', custoUnitario: 0.50, estoque: 200 }, 
      { id: 'acucar-g', nome: 'A√ß√∫car (Kg)', unidade: 'g', custoUnitario: 0.005, estoque: 5000 }, 
      { id: 'gelo-un', nome: 'Gelo (Dose)', unidade: 'un', custoUnitario: 0.05, estoque: 500 },
      { id: 'cerveja-garrafa', nome: 'Cerveja (Garrafa 600ml)', unidade: 'un', custoUnitario: 5.50, estoque: 500 },
      { id: 'refrigerante-lata', nome: 'Refrigerante (Lata 350ml)', unidade: 'un', custoUnitario: 3.50, estoque: 300 },
      { id: 'torresmo-porcao', nome: 'Torresmo (Por√ß√£o P)', unidade: 'un', custoUnitario: 12.00, estoque: 100 },
  ];
   
  const cardapioData = {
      bebidas: [
          { id: 1, nome: 'Cerveja Gelada', preco: 8.00, emoji: 'üç∫', categoria: 'Bebidas', 
              fichaTecnica: [ { idInsumo: 'cerveja-garrafa', quantidade: 1, unidade: 'un' } ] }, 
          { id: 2, nome: 'Refrigerante', preco: 6.00, emoji: 'ü•§', categoria: 'Bebidas',
              fichaTecnica: [ { idInsumo: 'refrigerante-lata', quantidade: 1, unidade: 'un' } ] },
          { id: 3, nome: '√Ågua com G√°s', preco: 4.00, emoji: 'üíß', categoria: 'Bebidas' },
          { id: 4, nome: '√Ågua sem G√°s', preco: 4.00, emoji: 'üíß', categoria: 'Bebidas' },
          { id: 5, nome: 'Suco Natural', preco: 10.00, emoji: 'üßÉ', categoria: 'Bebidas' },
      ],
      entradas: [
          { id: 6, nome: 'Torresmo Defumado', preco: 25.00, emoji: 'ü•ì', categoria: 'Entradas',
              fichaTecnica: [ { idInsumo: 'torresmo-porcao', quantidade: 1, unidade: 'un' } ] },
          { id: 7, nome: 'Cofrio', preco: 22.00, emoji: 'üçñ', categoria: 'Entradas' },
          { id: 8, nome: 'Franguinho', preco: 28.00, emoji: 'üçó', categoria: 'Entradas' },
          { id: 9, nome: 'F√≠gado', preco: 26.00, emoji: 'ü•©', categoria: 'Entradas' },
          { id: 10, nome: 'Caldos', preco: 18.00, emoji: 'üç≤', categoria: 'Entradas' },
          { id: 11, nome: 'P√£o com Lingui√ßa', preco: 20.00, emoji: 'üå≠', categoria: 'Entradas' },
          { id: 12, nome: 'Coxinha de Costela', preco: 24.00, emoji: 'ü•ü', categoria: 'Entradas' },
      ],
      pratos: [
          { id: 13, nome: 'Feijoada Completa', preco: 45.00, emoji: 'üçõ', categoria: 'Pratos Principais' },
          { id: 14, nome: 'Churrasco Premium', preco: 55.00, emoji: 'ü•©', categoria: 'Pratos Principais' },
          { id: 15, nome: 'Moqueca Capixaba', preco: 50.00, emoji: 'üêü', manutencao: true, categoria: 'Pratos Principais' },
      ],
      cocktails: [
          { id: 16, nome: 'Caipirinha', preco: 18.00, emoji: 'üçã', alcool: true, categoria: 'Cocktails',
              fichaTecnica: [ 
                  { idInsumo: 'cachaca-500', quantidade: 50, unidade: 'ml' }, 
                  { idInsumo: 'limao-un', quantidade: 1, unidade: 'un' },       
                  { idInsumo: 'acucar-g', quantidade: 10, unidade: 'g' },       
                  { idInsumo: 'gelo-un', quantidade: 3, unidade: 'un' }        
              ] }, 
          { id: 17, nome: 'Fitzgerald', preco: 22.00, emoji: 'üç∏', alcool: true, categoria: 'Cocktails' },
          { id: 18, nome: 'Aperol Spritz', preco: 24.00, emoji: 'üçä', alcool: true, categoria: 'Cocktails' },
          { id: 19, nome: 'Tom Collins', preco: 20.00, emoji: 'üç∏', alcool: true, categoria: 'Cocktails' },
          { id: 20, nome: 'Penicillin', preco: 25.00, emoji: 'ü•É', alcool: true, categoria: 'Cocktails' },
          { id: 21, nome: 'Whisky Sour', preco: 26.00, emoji: 'ü•É', alcool: true, categoria: 'Cocktails' },
          { id: 22, nome: 'Daiquiri', preco: 21.00, emoji: 'üçπ', alcool: true, categoria: 'Cocktails' },
          { id: 23, nome: 'Moscow Mule', preco: 23.00, emoji: 'üç∫', alcool: true, categoria: 'Cocktails' },
          { id: 24, nome: 'Rabo de Galo', preco: 19.00, emoji: 'üç∏', alcool: true, categoria: 'Cocktails' },
      ],
      mocktails: [
          { id: 25, nome: 'Ginger Ale', preco: 14.00, emoji: 'ü•§', alcool: false, categoria: 'Mocktails' },
          { id: 26, nome: 'Pineapple Fresh', preco: 15.00, emoji: 'üçç', alcool: false, categoria: 'Mocktails' },
          { id: 27, nome: 'Morango Especial', preco: 15.00, emoji: 'üçì', alcool: false, categoria: 'Mocktails' },
      ],
      vinhos: [ 
          { 
              id: 28, nome: 'Vinho Tinto', emoji: 'üç∑', categoria: 'Vinhos',
              opcoes: [
                  { id: 28.1, nomeOpcao: 'Ta√ßa', preco: 18.00 },
                  { id: 28.2, nomeOpcao: 'Garrafa', preco: 85.00 },
              ]
          },
          { 
              id: 29, nome: 'Vinho Branco', emoji: 'ü•Ç', categoria: 'Vinhos',
              opcoes: [
                  { id: 29.1, nomeOpcao: 'Ta√ßa', preco: 18.00 },
                  { id: 29.2, nomeOpcao: 'Garrafa', preco: 85.00 },
              ]
          },
          { 
              id: 30, nome: 'Espumante', emoji: 'üçæ', categoria: 'Vinhos',
              opcoes: [
                  { id: 30.1, nomeOpcao: 'Ta√ßa', preco: 20.00 },
                  { id: 30.2, nomeOpcao: 'Garrafa', preco: 95.00 },
              ]
          },
      ],
  };

  const initialProdutosDefault = getFlatMenu(cardapioData, initialInsumos);
  const initialProdutos = initialProdutosDefault.map(p => ({
    ...p,
    estoque: p.manutencao ? 0 : p.estoque,
  }));
  
  /**********
   * Login *
   **********/
  const defaultUser = { username: 'admin', password: '1234' };

  function Login({onLogin}){
    const [u, setU] = useState('');
    const [p, setP] = useState('');
    const [err, setErr] = useState('');

    function submit(e){
      e.preventDefault();
      if(u === defaultUser.username && p === defaultUser.password){
        onLogin({username: u});
      } else {
        setErr('Usu√°rio ou senha inv√°lidos');
      }
    }

    return (
      <div className="min-h-screen flex items-center justify-center p-6 bg-gradient-to-br from-dark via-cinzaEscuro to-dark">
        <div className="max-w-4xl w-full grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
          <div className="hidden md:flex flex-col items-center justify-center rounded-2xl p-8 bg-cinzaEscuro shadow-xl border-2 border-terracota">
            <div className="logo-bar mb-4">
              <div className="logo-inner">
                <div className="logo-stars">
                  <span className="star">‚òÖ</span>
                  <span className="star">‚òÖ</span>
                  <span className="star">‚òÖ</span>
                  <span className="star">‚òÖ</span>
                  <span className="star">‚òÖ</span>
                </div>
                <div className="logo-text">
                  <div className="logo-bar-text">THIAGO</div>
                  <div className="logo-do-gigante">SANTA TERESA</div>
                </div>
              </div>
            </div>
            <h1 className="text-3xl font-extrabold text-terracota">Thiago Santa Teresa</h1>
            <p className="mt-2 text-gray-300">Sistema de Ponto de Venda (PDV)</p>
            <div className="mt-6 text-sm text-gray-400">Dica: usu√°rio <b className="text-terracota">admin</b> / senha <b className="text-terracota">1234</b></div>
          </div>

          <form onSubmit={submit} className="bg-cinzaEscuro border-2 border-terracota rounded-2xl p-6 shadow-lg">
            <div className="flex items-center justify-between mb-6">
              <div>
                <h2 className="text-2xl font-bold text-terracota">Entrar</h2>
                <p className="text-sm text-gray-300">Acesse o sistema PDV</p>
              </div>
              <div className="text-2xl text-terracota">üîí</div>
              </div>

            <label className="block mb-4">
              <span className="text-sm text-gray-300">Usu√°rio</span>
              <input className="mt-1 block w-full p-3 border border-terracota bg-dark text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-terracota transition" value={u} onChange={e=>setU(e.target.value)} required />
            </label>

            <label className="block mb-4">
              <span className="text-sm text-gray-300">Senha</span>
              <input type="password" className="mt-1 block w-full p-3 border border-terracota bg-dark text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-terracota transition" value={p} onChange={e=>setP(e.target.value)} required />
            </label>

            {err && <div className="text-red-400 mb-3">{err}</div>}

            <button className="w-full py-3 rounded-xl font-bold bg-gradient-to-r from-terracota to-redBrown text-white shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition">Entrar</button>
          </form>
        </div>
      </div>
    );
  }

  /****************
   * Header, Side
   ****************/
  function Header({user, onLogout}){
    return (
      <header className="bg-white shadow sticky top-0 z-30 h-16 flex items-center justify-between px-6 border-b">
        <div className="flex items-center gap-4">
            <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-terracota to-redBrown">Thiago Santa Teresa PDV</h1>
            <div className="text-xs text-gray-500 hidden sm:block">(Simula√ß√£o LocalStorage)</div>
        </div>

        <div className="flex items-center gap-4 text-sm text-gray-600">
            <div className="flex items-center gap-2">
                <span className="text-green-500">üü¢</span> Caixa Aberto (Simula√ß√£o)
            </div>
            <div className="hidden sm:block">‚è±Ô∏è 16:15</div> 
            <div className="hidden sm:block">üìÖ 03/12/2025</div>
            <div className="hidden sm:block">Boa tarde</div> 
        </div>
      </header>
    );
  }

  function Sidebar({selected, setSelected, totalPedidosWeb, user, onLogout}){
    const itens = [
      { key:'dashboard', label:'üè† Dashboard' },
      { key:'mapa_mesas', label:'üó∫Ô∏è Mapa de Mesas' },
      { key:'pdv', label:'üõí PDV' },
      { key:'caixa_contas', label:'üí∞ Controle de Caixa / Contas' }, 
      { key:'produtos', label:'üì¶ Produtos (Venda)' },
      { key:'insumos', label:'üß™ Insumos/Estoque' },
      { key:'custo_insumos', label:'üìù Relat√≥rio de Insumos' },
      { key:'perdas', label:'‚ö†Ô∏è Registro de Perdas' },
      { key:'relatorios', label:'üìä Relat√≥rios' },
      { key:'avancado', label:'üìà Relat√≥rio Avan√ßado' }
    ];
    
    return (
      <aside className="w-64 bg-dark border-r border-cinzaEscuro hidden md:flex flex-col flex-shrink-0">
        <div className="p-4 flex flex-col items-center justify-center border-b border-cinzaEscuro">
            <div className="text-xl font-bold text-terracota">THIAGO</div>
            <div className="text-sm text-gray-400">SANTA TERESA PDV</div>
        </div>
        
        <div className="p-2 sidebar-scroll flex-1">
          {itens.map(i=>(
            <button key={i.key} onClick={()=>setSelected(i.key)}
              className={`flex items-center gap-3 w-full text-left px-4 py-3 rounded-lg my-1 text-md font-medium transition ${selected===i.key ? 'bg-terracota text-white shadow-lg' : 'text-gray-300 hover:bg-cinzaEscuro hover:text-white'}`}>
              <span>{i.label}</span>
            </button>
          ))}
        </div>
        
        <div className="p-4 border-t border-cinzaEscuro text-sm text-gray-400">
            <div className="flex items-center justify-between mb-2">
                <div>üë§ Logado como: <b className="text-terracota">{user?.username}</b></div>
            </div>
            <button onClick={onLogout} className="w-full py-1 rounded-lg border border-redBrown text-redBrown hover:bg-redBrown hover:text-white transition">Sair</button>
        </div>
      </aside>
    );
  }
  


  /*********************
   * NOVO: Mapa de Mesas View
   *********************/
  function MapaMesasView({ pedidos, selecionarMesa }) {
    // Gera mesas 1 a 12
    const mesas = Array.from({length: 12}, (_, i) => {
        const num = i + 1;
        const nomeMesa = `Mesa ${num < 10 ? '0'+num : num}`;
        
        // Busca pedidos ativos para esta mesa
        const pedidosMesa = pedidos.filter(p => 
            p.status !== 'Vendido' && 
            p.nomeCliente &&
            p.nomeCliente.toLowerCase().includes(nomeMesa.toLowerCase())
        );

        const total = pedidosMesa.reduce((acc, p) => acc + p.total, 0);
        const ocupada = pedidosMesa.length > 0;
        
        // Se tiver pedido PRONTO, fica amarelo (pagamento/entrega). Se tiver ocupada, vermelho. Se n√£o, verde.
        const status = ocupada ? (pedidosMesa.some(p => p.status === 'Pronto') ? 'pagamento' : 'ocupada') : 'livre';

        return { num, nome: nomeMesa, status, total, pedidos: pedidosMesa };
    });

    return (
        <div className="p-6 bg-slate-50 min-h-full">
            <h2 className="text-3xl font-extrabold text-gray-800 border-b pb-2 mb-6 flex items-center gap-3">
                <span className="text-4xl text-terracota">üó∫Ô∏è</span> Mapa do Sal√£o
            </h2>
            
            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6">
                {mesas.map(m => (
                    <div key={m.num} 
                         onClick={() => selecionarMesa(m.nome)}
                         className={`mesa-card shadow-lg ${m.status === 'livre' ? 'mesa-livre' : m.status === 'ocupada' ? 'mesa-ocupada' : 'mesa-pagamento'}`}>
                        <div className="text-3xl font-bold">{m.num}</div>
                        <div className="text-sm mt-1 font-semibold">{m.status === 'livre' ? 'LIVRE' : currency(m.total)}</div>
                        {m.status !== 'livre' && <div className="text-xs mt-1 bg-black/20 px-2 rounded">{m.pedidos.length} ped.</div>}
                    </div>
                ))}
            </div>

            <div className="mt-8 flex gap-6 justify-center bg-white p-4 rounded-xl shadow-sm border w-fit mx-auto">
                <div className="flex items-center gap-2"><div className="w-4 h-4 bg-green-500 border-2 border-green-700 rounded-full"></div> <span className="text-sm text-gray-600">Livre</span></div>
                <div className="flex items-center gap-2"><div className="w-4 h-4 bg-red-500 border-2 border-red-700 rounded-full"></div> <span className="text-sm text-gray-600">Ocupada</span></div>
                <div className="flex items-center gap-2"><div className="w-4 h-4 bg-yellow-500 border-2 border-yellow-700 rounded-full"></div> <span className="text-sm text-gray-600">Pedido Pronto/Conta</span></div>
            </div>
        </div>
    );
  }

  /*********************
   * Dashboard View
   *********************/
  function DashboardView({ vendas, perdas, produtos }) {
      const areaRef = useRef(null);
      const pieRef = useRef(null);
      
      const salesData = useMemo(() => {
          let totalSales = 0;
          let totalCosts = 0;
          let totalLosses = 0;
          let totalTickets = vendas.length;
          
          vendas.forEach(v => {
              totalSales += v.total;
              totalCosts += v.custoVenda || 0;
          });
          
          perdas.forEach(p => {
              totalLosses += p.custoTotal;
          });
          
          const totalProfit = totalSales - totalCosts - totalLosses;
          const averageTicket = totalTickets > 0 ? totalSales / totalTickets : 0;
          const averageProfit = totalTickets > 0 ? totalProfit / totalTickets : 0;
          
          return { totalSales, totalCosts, totalLosses, totalTickets, totalProfit, averageTicket, averageProfit };
      }, [vendas, perdas]);

      const dailySalesChartData = useMemo(() => {
        const map = {};
        vendas.forEach(v => {
          const day = v.data.split('T')[0];
          map[day] = (map[day] || 0) + v.total;
        });
        const arr = Object.entries(map).map(([d, t]) => ({ date: d, receita: t }));
        arr.sort((a, b) => a.date.localeCompare(b.date));
        return arr;
      }, [vendas]);
      
      const categorySalesChartData = useMemo(() => {
          const map = {};
          vendas.forEach(v => {
              v.itens.forEach(item => {
                  const product = produtos.find(p => p.id === item.id);
                  if (product) {
                      map[product.categoria] = (map[product.categoria] || 0) + item.preco * item.quantidade;
                  }
              });
          });
          return Object.entries(map).map(([categoria, total]) => ({ categoria, total }));
      }, [vendas, produtos]);

      useEffect(() => {
          if (areaRef.current && areaRef.current._chart) { try { areaRef.current._chart.destroy(); } catch { } }
          
          if (areaRef.current && dailySalesChartData.length > 0) {
              const ctx = areaRef.current.getContext('2d');
              const labels = dailySalesChartData.map(s => new Date(s.date).toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' }));
              const dataReceita = dailySalesChartData.map(s => s.receita);
              
              const backgroundColors = dataReceita.map(r => '#e4593c'); 
              const borderColors = dataReceita.map(r => '#a93131');
              
              areaRef.current._chart = new Chart(ctx, {
                  type: 'bar',
                  data: { 
                      labels, 
                      datasets: [{ 
                          label: 'Receita (R$)', 
                          data: dataReceita, 
                          backgroundColor: backgroundColors, 
                          borderColor: borderColors,
                          borderWidth: 1,
                          barThickness: 15,
                      }] 
                  },
                  options: { 
                      responsive: true, 
                      maintainAspectRatio: false,
                      plugins: { legend: { display: false } },
                      scales: {
                          x: { grid: { display: false } },
                          y: { beginAtZero: true }
                      }
                  }
              });
          }
      }, [dailySalesChartData]);

      useEffect(() => {
          if (pieRef.current && pieRef.current._chart) { try { pieRef.current._chart.destroy(); } catch { } }

          if (pieRef.current && categorySalesChartData.length > 0) {
              const ctx = pieRef.current.getContext('2d');
              const labels = categorySalesChartData.map(d => d.categoria);
              const data = categorySalesChartData.map(d => d.total);
              const backgroundColors = [
                '#e4593c', '#a93131', '#fcd34d', '#10b981', '#3b82f6', '#f97316'
              ];

              pieRef.current._chart = new Chart(ctx, {
                  type: 'doughnut',
                  data: { 
                      labels, 
                      datasets: [{ 
                          data, 
                          backgroundColor: backgroundColors, 
                          borderColor: '#fff',
                          borderWidth: 2,
                      }] 
                  },
                  options: { 
                      responsive: true, 
                      maintainAspectRatio: false,
                      plugins: { legend: { position: 'bottom' } }
                  }
              });
          }
      }, [categorySalesChartData]);

      return (
          <div className="p-6 bg-slate-50 min-h-full">
              <div className="flex justify-between items-center border-b pb-4 mb-6">
                  <h2 className="text-2xl font-bold text-gray-800">Painel de Vendas - {new Date().toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}</h2>
              </div>
              
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                  <div className="onchef-card bg-green-600">
                      <div className="onchef-card-subtitle">Total de Vendas no Per√≠odo</div>
                      <div className="onchef-card-title">{currency(salesData.totalSales)}</div>
                      <div className="text-right text-xs opacity-90">Total de {salesData.totalTickets} Vendas</div>
                  </div>
                  <div className="onchef-card bg-red-600">
                      <div className="onchef-card-subtitle">Custo Total dos Produtos (CMV)</div>
                      <div className="onchef-card-title">{currency(salesData.totalCosts)}</div>
                      <div className="text-right text-xs opacity-90">Perdas: {currency(salesData.totalLosses)}</div>
                  </div>
                  <div className="onchef-card bg-terracota">
                      <div className="onchef-card-subtitle">Lucro Bruto (Vendas - Custo - Perdas)</div>
                      <div className="onchef-card-title">{currency(salesData.totalProfit)}</div>
                      <div className="text-right text-xs opacity-90">Margem: {(salesData.totalSales > 0 ? (salesData.totalProfit / salesData.totalSales) * 100 : 0).toFixed(1)}%</div>
                  </div>
                  <div className="onchef-card bg-blue-600">
                      <div className="onchef-card-subtitle">Ticket M√©dio (Valor por Venda)</div>
                      <div className="onchef-card-title">{currency(salesData.averageTicket)}</div>
                      <div className="text-right text-xs opacity-90">Lucro M√©dio: {currency(salesData.averageProfit)}</div>
                  </div>
              </div>
              
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div className="bg-white p-4 rounded-2xl shadow-lg border">
                      <h3 className="font-bold text-lg mb-4 text-gray-700">Vendas por Dia</h3>
                      <div style={{ height: 350 }}>
                          {dailySalesChartData.length > 0 ? <canvas ref={areaRef}></canvas> : <div className="text-gray-500 text-center py-10">Sem dados</div>}
                      </div>
                  </div>
                  <div className="bg-white p-4 rounded-2xl shadow-lg border">
                      <h3 className="font-bold text-lg mb-4 text-gray-700">Vendas por Categoria (Receita)</h3>
                      <div style={{ height: 350 }}>
                          {categorySalesChartData.length > 0 ? <canvas ref={pieRef}></canvas> : <div className="text-gray-500 text-center py-10">Sem dados</div>}
                      </div>
                  </div>
              </div>
          </div>
      );
  }

  /*********************
   * PDV 
   *********************/
  function PDVView({produtos, adicionarAoCarrinho, busca, setBusca, carrinho, alterarQuantidade, removerDoCarrinho, finalizarVenda, totalCarrinho}){
    const [categoriaAtiva, setCategoriaAtiva] = useState('Todos');

    const categorias = useMemo(() => {
      const cats = produtos.map(p => p.categoria);
      return ['Todos', ...new Set(cats.filter(c => c))];
    }, [produtos]);

    const produtosFiltrados = produtos.filter(p => {
      const matchesBusca = p.nome.toLowerCase().includes(busca.toLowerCase()) || 
                           p.categoria.toLowerCase().includes(busca.toLowerCase());
      const matchesCategoria = categoriaAtiva === 'Todos' || p.categoria === categoriaAtiva;
      
      return matchesBusca && matchesCategoria;
    });

    return (
      <div className="space-y-4">
        <div className="bg-white p-4 rounded-2xl shadow space-y-4">
          <input 
            value={busca} 
            onChange={e=>setBusca(e.target.value)} 
            placeholder="Pesquisar produto..." 
            className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-terracota transition" 
          />
          <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
            {categorias.map(cat => (
              <button
                key={cat}
                onClick={() => setCategoriaAtiva(cat)}
                className={`px-6 py-2 rounded-full whitespace-nowrap font-medium transition ${
                  categoriaAtiva === cat 
                  ? 'bg-terracota text-white shadow-md' 
                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                }`}
              >
                {cat}
              </button>
            ))}
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2">
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {produtosFiltrados.map(produto => (
                <div key={produto.id}
                     onClick={()=>adicionarAoCarrinho(produto)}
                     className={`p-4 rounded-2xl border cursor-pointer shadow-sm hover:shadow-lg transform hover:-translate-y-1 transition bg-white ${produto.manutencao ? 'opacity-50 cursor-not-allowed border-red-400' : 'border-gray-200'}`}>
                  
                  {produto.imagemUrl && !produto.imagemUrl.includes('placeholder') ? (
                      <img src={produto.imagemUrl} alt={produto.nome} className="w-full h-24 object-cover rounded-xl mb-3" />
                  ) : (
                      <div className="w-full h-24 bg-gray-100 rounded-xl mb-3 flex items-center justify-center text-3xl">{produto.emoji}</div>
                  )}

                  <div className="flex items-start justify-between gap-3">
                    <div>
                      <div className="text-xs font-bold text-terracota uppercase">{produto.categoria}</div>
                      <div className="font-semibold text-lg mt-1">{produto.nome}</div>
                    </div>
                    <div className="text-right">
                      <div className="text-gray-900 font-bold text-lg">{currency(produto.preco)}</div>
                    </div>
                  </div>
                </div>
              ))}
              {produtosFiltrados.length === 0 && (
                <div className="col-span-full py-10 text-center text-gray-400">
                  Nenhum produto encontrado nesta categoria.
                </div>
              )}
            </div>
          </div>

          <div className="bg-white p-4 rounded-2xl shadow h-fit sticky top-20 flex flex-col">
            <h3 className="font-bold text-lg flex items-center gap-2 text-terracota">üßæ Carrinho</h3>
            <div className="mt-3 flex-1 max-h-96 overflow-y-auto space-y-3">
               {carrinho.map(item=>(
                 <div key={item.id} className="p-3 border rounded-lg">
                    <div className="flex justify-between font-medium">
                      <span>{item.nome}</span>
                      <span>{currency(item.preco * item.quantidade)}</span>
                    </div>
                    <div className="flex items-center gap-2 mt-2">
                      <button onClick={()=>alterarQuantidade(item.id, item.quantidade - 1)} className="px-2 border rounded">-</button>
                      <span>{item.quantidade}</span>
                      <button onClick={()=>alterarQuantidade(item.id, item.quantidade + 1)} className="px-2 border rounded">+</button>
                      <button onClick={()=>removerDoCarrinho(item.id)} className="ml-auto text-red-500 text-xs">Remover</button>
                    </div>
                 </div>
               ))}
            </div>
            <div className="mt-4 border-t pt-3">
               <div className="flex justify-between font-bold text-xl mb-4">
                 <span>Total</span>
                 <span>{currency(totalCarrinho)}</span>
               </div>
               <button 
                 onClick={finalizarVenda}
                 disabled={carrinho.length === 0}
                 className="w-full py-3 bg-green-600 text-white rounded-xl font-bold disabled:opacity-50"
               >
                 Finalizar Venda
               </button>
            </div>
          </div>
        </div>
      </div>
    );
  }
  
  function PedidosWeb({ pedidos, setPedidos, pedidosPendentesWeb, setPedidosPendentesWeb, finalizarPedidoEGerarVenda }) {
    
    function aceitarPedido(pedido) {
        if (!confirm(`Aceitar pedido de ${pedido.nomeCliente} e envi√°-lo para preparo?`)) return;

        const novoPedidoCozinha = {
            id: uid(),
            data: new Date().toISOString(),
            nomeCliente: pedido.nomeCliente,
            itens: pedido.itens,
            total: pedido.total,
            status: 'Pendente',
            tipo: 'Venda Web',
            itens: pedido.itens.map(item => {
                const produtoBase = initialProdutos.find(p => p.id === item.id || String(p.id).replace('.', '-') === String(item.id));
                return { ...item, custoUnitario: produtoBase?.custoProduto || 0 };
            })
        };

        setPedidos(prevPedidos => [...prevPedidos, novoPedidoCozinha]);

        const novosWeb = pedidosPendentesWeb.filter(p => p.id !== pedido.id);
        setPedidosPendentesWeb(novosWeb);
        
        localStorage.setItem('pedidos_web_pendentes', JSON.stringify(novosWeb.map(p => ({
             id: p.id,
             data: p.data,
             nomeCliente: p.nomeCliente,
             itens: p.itens,
             total: p.total
        }))));
    }
    
    function rejeitarPedido(pedido) {
        if (!confirm(`Rejeitar pedido de ${pedido.nomeCliente}? Isso ir√° remov√™-lo.`)) return;
        
        const novosWeb = pedidosPendentesWeb.filter(p => p.id !== pedido.id);
        setPedidosPendentesWeb(novosWeb);
        localStorage.setItem('pedidos_web_pendentes', JSON.stringify(novosWeb.map(p => ({
             id: p.id,
             data: p.data,
             nomeCliente: p.nomeCliente,
             itens: p.itens,
             total: p.total
        }))));
    }
    
    function alterarStatus(id, novoStatus) {
      const novosPedidos = pedidos.map(p => p.id === id ? { ...p, status: novoStatus } : p);
      setPedidos(novosPedidos);
    }
    
    const pedidosPendentes = pedidos.filter(p => p.status === 'Pendente');
    const pedidosEmPreparo = pedidos.filter(p => p.status === 'Em Preparo');
    const pedidosFinalizados = pedidos.filter(p => p.status === 'Vendido');

    return (
      <div className="space-y-6">
        <h2 className="text-3xl font-extrabold text-gray-800 border-b pb-2 flex items-center gap-3">
          <span className="text-4xl text-terracota">üåê</span> Gest√£o de Pedidos (Visualiza√ß√£o Admin)
        </h2>
        
        <p className="text-sm text-gray-600 bg-yellow-100 p-3 rounded-xl border border-yellow-300">
            üîî Nota: Esta tela √© uma visualiza√ß√£o administrativa. A tela principal da cozinha para o preparo e finaliza√ß√£o de pedidos deve ser acessada via **`cozinha.html`**.
        </p>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="p-4 rounded-2xl shadow border border-red-200 bg-red-50">
            <h3 className="font-bold text-xl mb-4 text-red-700">NOVOS ({pedidosPendentesWeb.length + pedidosPendentes.length})</h3>
            <div className="space-y-4 max-h-[70vh] overflow-y-auto">
              {pedidosPendentesWeb.map(p => (
                <div key={p.id} className="p-3 bg-white rounded-xl shadow-md border-2 border-green-500">
                  <div className="font-bold text-lg text-green-700 flex justify-between items-center">
                      <span>{p.nomeCliente}</span>
                      <span className="text-sm bg-green-100 text-green-700 px-2 py-0.5 rounded-full">WEB</span>
                  </div>
                  <div className="text-xs text-gray-500 mb-2">Recebido em: {new Date(p.data).toLocaleTimeString()}</div>
                  <ul className="list-disc list-inside text-sm mb-3 ml-3">
                    {p.itens.map(it => <li key={it.id}>{it.quantidade}x {it.nome}</li>)}
                  </ul>
                  <div className="font-bold text-lg text-terracota">Total: {currency(p.total)}</div>

                  <div className="mt-3 flex gap-2">
                    <button onClick={() => aceitarPedido(p)} className="flex-1 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">‚úÖ Aceitar</button>
                    <button onClick={() => rejeitarPedido(p)} className="py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600">‚úï</button>
                  </div>
                </div>
              ))}
              
              {pedidosPendentes.map(p => (
                <div key={p.id} className="p-3 bg-white rounded-xl shadow-md border border-red-300">
                  <div className="font-bold text-lg text-red-600 flex justify-between items-center">
                    <span>{p.nomeCliente}</span>
                    <span className="text-sm bg-red-100 text-red-700 px-2 py-0.5 rounded-full">{p.tipo === 'Venda Direta' ? 'PDV' : 'WEB ACEITO'}</span>
                  </div>
                  <div className="text-xs text-gray-500 mb-2">Data: {new Date(p.data).toLocaleTimeString()}</div>
                  <ul className="list-disc list-inside text-sm mb-3 ml-3">
                    {p.itens.map(it => <li key={it.id}>{it.quantidade}x {it.nome}</li>)}
                  </ul>
                  <div className="font-bold text-lg">{currency(p.total)}</div>

                  <button onClick={() => alterarStatus(p.id, 'Em Preparo')} className="w-full mt-3 py-2 bg-terracota text-white rounded-lg hover:bg-redBrown">Iniciar Preparo</button>
                </div>
              ))}
              
              {pedidosPendentesWeb.length === 0 && pedidosPendentes.length === 0 && <div className="text-gray-500 text-center py-6">Nenhum novo pedido</div>}
            </div>
          </div>

          <div className="p-4 rounded-2xl shadow border border-yellow-200 bg-yellow-50">
            <h3 className="font-bold text-xl mb-4 text-yellow-700">EM PREPARO - {pedidosEmPreparo.length}</h3>
            <div className="space-y-4 max-h-[70vh] overflow-y-auto">
              {pedidosEmPreparo.map(p => {
                return (
                  <div key={p.id} className={`p-3 bg-white rounded-xl shadow-md border border-yellow-300`}>
                    <div className={`font-bold text-xl text-yellow-600`}>
                      {p.nomeCliente}
                    </div>
                  <div className="text-xs text-gray-500 mb-2">Origem: {p.tipo}</div>
                    <ul className="list-disc list-inside text-sm mb-3 ml-3">
                      {p.itens.map(it => <li key={it.id}>{it.quantidade}x {it.nome}</li>)}
                    </ul>
                    <div className="font-bold text-lg">{currency(p.total)}</div>
                    
                    <button 
                      onClick={() => finalizarPedidoEGerarVenda(p)} 
                      className="w-full mt-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"
                    >
                      ‚úÖ Finalizar e Vender
                    </button>
                  </div>
                );
              })}
              {pedidosEmPreparo.length === 0 && <div className="text-gray-500 text-center py-6">Nenhum em preparo</div>}
            </div>
          </div>
          
          <div className="p-4 rounded-2xl shadow border border-green-200 bg-green-50">
            <h3 className="font-bold text-xl mb-4 text-green-700">FINALIZADOS (√öltimos 5)</h3>
            <div className="space-y-4 max-h-[70vh] overflow-y-auto">
              {pedidosFinalizados.sort((a,b) => new Date(b.data) - new Date(a.data)).slice(0, 5).map(p => ( 
                <div key={p.id} className="p-3 bg-white rounded-xl shadow-md border border-green-300">
                  <div className="font-bold text-lg text-green-600">{p.nomeCliente}</div>
                  <div className="text-xs text-gray-500">{new Date(p.data).toLocaleTimeString()}</div>
                  <div className="text-right font-bold text-lg">{currency(p.total)}</div>
                </div>
              ))}
              {pedidosFinalizados.length === 0 && <div className="text-gray-500 text-center py-6">Nenhum finalizado</div>}
            </div>
          </div>
        </div>
      </div>
    );
  }

  function CaixaContasView({ vendas, pedidos, finalizarPedidoEGerarVenda }) {
      const [contasEmAberto, setContasEmAberto] = useState(pedidos.filter(p => p.status !== 'Vendido'));
      const [sangria, setSangria] = useState('');
      const [historicoCaixa, setHistoricoCaixa] = useState(storageGet('historico_caixa', []));
      
      useEffect(() => {
          setContasEmAberto(pedidos.filter(p => p.status !== 'Vendido'));
      }, [pedidos]);

      function registrarSangria(e) {
          e.preventDefault();
          const valor = Number(sangria);
          if (valor <= 0) return alert('Valor inv√°lido.');

          const novaSangria = {
              id: uid(),
              data: new Date().toISOString(),
              tipo: 'Sangria',
              valor: -valor, 
              descricao: 'Retirada de troco/adiantamento'
          };
          
          const novoHistorico = [...historicoCaixa, novaSangria];
          storageSet('historico_caixa', novoHistorico);
          setHistoricoCaixa(novoHistorico);
          setSangria('');
          alert(`Sangria de ${currency(valor)} registrada!`);
      }
      
      function fecharConta(pedido) {
          if(pedido.status !== 'Pronto') {
              alert("Aguarde a cozinha finalizar o pedido (status 'Pronto') antes de fechar a conta.");
              return;
          }
          finalizarPedidoEGerarVenda(pedido);
      }

      const totalVendasCaixa = vendas.reduce((sum, v) => sum + v.total, 0);
      const totalSangrias = historicoCaixa.filter(h => h.tipo === 'Sangria').reduce((sum, h) => sum + h.valor, 0);
      const saldoEstimado = totalVendasCaixa + totalSangrias;

      return (
          <div className="p-6 bg-slate-50 min-h-full space-y-6">
              <h2 className="text-3xl font-extrabold text-gray-800 border-b pb-2 flex items-center gap-3">
                  <span className="text-4xl text-terracota">üí∞</span> Controle de Caixa & Contas
              </h2>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <div className="onchef-card bg-red-600/90">
                      <div className="onchef-card-subtitle">Contas Ativas (Aguardando Preparo/Fechamento)</div>
                      <div className="onchef-card-title">{contasEmAberto.length} Pedidos</div>
                  </div>
                  
                  <div className="onchef-card bg-blue-600/90">
                      <div className="onchef-card-subtitle">Receita Total de Vendas (no per√≠odo)</div>
                      <div className="onchef-card-title">{currency(totalVendasCaixa)}</div>
                  </div>
                  
                  <div className="onchef-card bg-yellow-600/90">
                      <div className="onchef-card-subtitle">Sangrias Registradas</div>
                      <div className="onchef-card-title">{currency(Math.abs(totalSangrias))}</div>
                      <div className="text-right text-xs opacity-90">Saldo Estimado (Total): {currency(saldoEstimado)}</div>
                  </div>
              </div>
              
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                  <div className="bg-white p-4 rounded-2xl shadow border lg:col-span-2">
                      <h3 className="font-bold text-lg mb-4 text-terracota">Contas Abertas para Cobran√ßa</h3>
                      <div className="space-y-3 max-h-96 overflow-y-auto">
                          {contasEmAberto.sort((a,b) => new Date(a.data) - new Date(b.data)).map(p => (
                              <div key={p.id} className={`p-3 rounded-xl border ${p.status === 'Pendente' ? 'bg-red-50' : p.status === 'Em Preparo' ? 'bg-yellow-50' : p.status === 'Pronto' ? 'bg-green-100' : 'bg-green-50'}`}>
                                  <div className="flex justify-between items-center">
                                      <div className="font-bold text-lg">{p.nomeCliente}</div>
                                      <div className="text-terracota font-bold">{currency(p.total)}</div>
                                  </div>
                                  <div className="text-sm text-gray-600">
                                      Status: <b className={`font-semibold ${p.status === 'Pendente' ? 'text-red-500' : p.status === 'Em Preparo' ? 'text-yellow-500' : 'text-green-500'}`}>{p.status}</b> | Origem: {p.tipo}
                                  </div>
                                  <ul className="list-disc list-inside text-xs ml-3 mt-1 text-gray-500">
                                      {p.itens.map(it => <li key={it.id}>{it.quantidade}x {it.nome}</li>)}
                                  </ul>
                                  <button onClick={() => fecharConta(p)} 
                                      className={`w-full mt-3 py-2 text-white rounded-lg transition ${p.status === 'Pronto' ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-400 cursor-not-allowed'}`}
                                      disabled={p.status !== 'Pronto'}
                                  >
                                      {p.status === 'Pronto' ? '‚úÖ Cobrar & Fechar Conta' : 'Aguardando Cozinha...'}
                                  </button>
                              </div>
                          ))}
                          {contasEmAberto.length === 0 && <div className="text-gray-500 text-center py-6">Nenhuma conta aberta.</div>}
                      </div>
                  </div>
                  
                  <div className="bg-white p-4 rounded-2xl shadow border">
                      <h3 className="font-bold text-lg mb-4 text-red-700">Registrar Sangria (Retirada de Caixa)</h3>
                      <form onSubmit={registrarSangria} className="space-y-3 mb-6 border-b pb-4">
                          <input value={sangria} onChange={e => setSangria(e.target.value)} placeholder="Valor R$" type="number" step="0.01" className="w-full p-3 border rounded-xl" required />
                          <button className="w-full py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600">üî¥ Registrar Sangria</button>
                      </form>
                      
                      <h4 className="font-bold text-sm mb-3">Hist√≥rico de Movimenta√ß√µes</h4>
                      <div className="space-y-2 text-sm max-h-56 overflow-y-auto">
                          {historicoCaixa.sort((a,b) => new Date(b.data) - new Date(a.data)).slice(0, 10).map(h => (
                              <div key={h.id} className={`flex justify-between p-2 rounded-lg ${h.tipo === 'Sangria' ? 'bg-red-100' : 'bg-green-100'}`}>
                                  <div>
                                      {h.tipo} - <span className="text-xs text-gray-500">{new Date(h.data).toLocaleTimeString()}</span>
                                  </div>
                                  <div className={`font-bold ${h.valor < 0 ? 'text-red-700' : 'text-green-700'}`}>
                                      {currency(Math.abs(h.valor))}
                                  </div>
                              </div>
                          ))}
                          {historicoCaixa.length === 0 && <div className="text-gray-500 text-center py-2">Nenhum registro.</div>}
                      </div>
                  </div>
              </div>
          </div>
      );
  }

  function ProdutosView({produtos, salvarProdutos, insumos}){
    const [form, setForm] = useState({ id:null, nome:'', preco:'', estoque:'', categoria:'', imagemUrl:'', fichaTecnica: [] });
    const [insumoForm, setInsumoForm] = useState({ idInsumo: '', quantidade: '' });
    
    // Novos estados para filtro
    const [busca, setBusca] = useState('');
    const [categoriaFiltro, setCategoriaFiltro] = useState('Todas');
    
    const insumosMap = insumos.reduce((map, i) => { map[i.id] = i; return map; }, {});

    useEffect(() => {
        if(form.id) {
             const produtoParaEditar = produtos.find(p => p.id === form.id);
             setForm(p => ({ 
                 ...p, 
                 fichaTecnica: produtoParaEditar.fichaTecnica || [] 
             }));
        }
    }, [form.id]);

    // Extrair categorias para o filtro
    const listaCategorias = useMemo(() => {
        const cats = produtos.map(p => p.categoria).filter(c => c && c.trim() !== '');
        return ['Todas', ...new Set(cats)];
    }, [produtos]);

    // Filtrar produtos
    const produtosFiltrados = produtos.filter(p => {
        const matchesBusca = p.nome.toLowerCase().includes(busca.toLowerCase());
        const matchesCategoria = categoriaFiltro === 'Todas' || p.categoria === categoriaFiltro;
        return matchesBusca && matchesCategoria;
    });

    function submit(e){
      e.preventDefault();
      if(!form.nome || !form.preco || !form.estoque) return alert('Preencha os campos obrigat√≥rios');
      
      const novoId = form.id || uid();
      const novo = { 
        ...form, 
        preco: Number(form.preco), 
        estoque: Number(form.estoque), 
        id: novoId 
      };
      
      novo.custoProduto = calcularCusto(novo, insumosMap);

      let novos;
      if(form.id) novos = produtos.map(p=> p.id===form.id ? novo : p);
      else novos = [...produtos, novo];
      
      salvarProdutos(novos);
      setForm({ id:null, nome:'', preco:'', estoque:'', categoria:'', imagemUrl:'', fichaTecnica: [] });
    }

    function editar(p){ setForm({...p, preco: String(p.preco), estoque: String(p.estoque), imagemUrl: p.imagemUrl || '', fichaTecnica: p.fichaTecnica || [] }); }
    function excluir(p){ if(!confirm(`Excluir ${p.nome}?`)) return; salvarProdutos(produtos.filter(x=>x.id!==p.id)); }
    
    function adicionarInsumo() {
        if (!insumoForm.idInsumo || !insumoForm.quantidade) return;
        const insumoExistente = form.fichaTecnica.find(i => i.idInsumo === insumoForm.idInsumo);
        if (insumoExistente) {
            alert("Insumo j√° adicionado. Edite a quantidade.");
            return;
        }
        
        const insumoData = insumosMap[insumoForm.idInsumo];

        setForm({
            ...form,
            fichaTecnica: [
                ...form.fichaTecnica,
                {
                    idInsumo: insumoForm.idInsumo,
                    quantidade: Number(insumoForm.quantidade),
                    unidade: insumoData.unidade,
                }
            ]
        });
        setInsumoForm({ idInsumo: '', quantidade: '' });
    }
    
    function removerInsumo(idInsumo) {
        setForm({
            ...form,
            fichaTecnica: form.fichaTecnica.filter(i => i.idInsumo !== idInsumo)
        });
    }


    return (
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="bg-white p-4 rounded-2xl shadow lg:col-span-1">
          <h3 className="font-bold mb-3">{form.id ? 'Editar' : 'Novo'} Produto</h3>
          <form onSubmit={submit} className="space-y-3">
            <input value={form.nome} onChange={e=>setForm({...form, nome:e.target.value})} placeholder="Nome" className="w-full p-3 border rounded-xl" required />
            <input value={form.preco} onChange={e=>setForm({...form, preco:e.target.value})} placeholder="Pre√ßo" type="number" step="0.01" className="w-full p-3 border rounded-xl" required />
            <input value={form.estoque} onChange={e=>setForm({...form, estoque:e.target.value})} placeholder="Estoque" type="number" className="w-full p-3 border rounded-xl" required />
            <input value={form.categoria} onChange={e=>setForm({...form, categoria:e.target.value})} placeholder="Categoria" className="w-full p-3 border rounded-xl" />
            
            <input value={form.imagemUrl} onChange={e=>setForm({...form, imagemUrl:e.target.value})} placeholder="URL da Imagem (opcional)" className="w-full p-3 border rounded-xl" />
            {form.imagemUrl && <img src={form.imagemUrl} alt="Preview" className="w-full h-24 object-cover rounded-xl mt-2" />}
            
            <div className="border-t pt-3 mt-4">
                <h4 className="font-bold text-sm mb-2 text-terracota">Ficha T√©cnica (Insumos/Receita)</h4>
                
                <div className="space-y-2 mb-3">
                    {form.fichaTecnica.map(item => (
                        <div key={item.idInsumo} className="flex justify-between items-center bg-gray-50 p-2 rounded-lg text-sm">
                            <span>{insumosMap[item.idInsumo]?.nome || 'Insumo Desconhecido'}</span>
                            <div className="flex items-center gap-2">
                                <span>{item.quantidade} {item.unidade}</span>
                                <button type="button" onClick={() => removerInsumo(item.idInsumo)} className="text-red-500 hover:text-red-700">x</button>
                            </div>
                        </div>
                    ))}
                </div>

                <div className="flex gap-2 mb-3">
                    <select value={insumoForm.idInsumo} onChange={e => setInsumoForm({...insumoForm, idInsumo: e.target.value})} className="flex-1 p-3 border rounded-xl">
                        <option value="">Selecione Insumo</option>
                        {insumos.map(i => <option key={i.id} value={i.id}>{i.nome} ({i.unidade})</option>)}
                    </select>
                    <input value={insumoForm.quantidade} onChange={e => setInsumoForm({...insumoForm, quantidade: e.target.value})} placeholder="Qtd" type="number" step="any" className="w-20 p-3 border rounded-xl" />
                    <button type="button" onClick={adicionarInsumo} className="px-4 py-3 bg-green-500 text-white rounded-xl">+</button>
                </div>
            </div>


            <div className="flex gap-3">
              <button className="flex-1 py-3 bg-gradient-to-r from-terracota to-redBrown text-white rounded-xl font-semibold shadow">{form.id ? 'Atualizar' : 'Adicionar'}</button>
              {form.id && <button type="button" onClick={()=>setForm({ id:null, nome:'', preco:'', estoque:'', categoria:'', imagemUrl:'', fichaTecnica:[] })} className="py-3 px-4 border rounded-xl hover:bg-gray-100">Cancelar</button>}
            </div>
          </form>
        </div>

        <div className="lg:col-span-2 bg-white p-4 rounded-2xl shadow">
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
             <h3 className="font-bold whitespace-nowrap">Produtos de Venda</h3>
             <div className="flex flex-1 w-full sm:w-auto gap-2">
                <input 
                    value={busca} 
                    onChange={e => setBusca(e.target.value)} 
                    placeholder="Pesquisar por nome..." 
                    className="w-full sm:w-48 p-2 text-sm border rounded-lg focus:outline-none focus:ring-1 focus:ring-terracota"
                />
                <select 
                    value={categoriaFiltro} 
                    onChange={e => setCategoriaFiltro(e.target.value)} 
                    className="p-2 text-sm border rounded-lg focus:outline-none focus:ring-1 focus:ring-terracota"
                >
                    {listaCategorias.map(c => <option key={c} value={c}>{c}</option>)}
                </select>
             </div>
          </div>
          
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-gradient-to-r from-red-50 to-red-100">
                <tr>
                  <th className="p-3 text-left">Produto</th>
                  <th className="p-3 text-left">Categoria</th>
                  <th className="p-3 text-right">Pre√ßo</th>
                  <th className="p-3 text-right">Custo</th>
                  <th className="p-3 text-center">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                {produtosFiltrados.map(p=>(
                  <tr key={p.id} className="border-b hover:bg-gray-50">
                    <td className="p-3">
                        {p.imagemUrl && !p.imagemUrl.includes('placeholder') ? (
                          <img src={p.imagemUrl} alt="" className="w-8 h-8 object-cover rounded-full inline mr-2" />
                        ) : (
                          <span className="text-lg mr-2 inline-block">{p.emoji}</span>
                        )}
                        {p.nome}
                    </td>
                    <td className="p-3">{p.categoria}</td>
                    <td className="p-3 text-right">{currency(p.preco)}</td>
                    <td className="p-3 text-right text-green-600">{currency(p.custoProduto)}</td>
                    <td className="p-3 text-center">
                      <div className="flex items-center justify-center gap-3">
                        <button onClick={()=>editar(p)} className="text-terracota hover:underline">Editar</button>
                        <button onClick={()=>excluir(p)} className="text-red-600 hover:underline">Excluir</button>
                    </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
            {produtosFiltrados.length === 0 && (
                <div className="p-4 text-center text-gray-500">Nenhum produto encontrado.</div>
            )}
          </div>
        </div>
      </div>
    );
  }
  
  function InsumosView({ insumos, salvarInsumos }) {
    const [form, setForm] = useState({ id:null, nome:'', unidade:'un', custoUnitario:'', estoque:'' });

    function submit(e){
      e.preventDefault();
      if(!form.nome || !form.custoUnitario || !form.estoque) return alert('Preencha os campos obrigat√≥rios');
      
      const novoId = form.id || (form.nome.toLowerCase().replace(/\s/g, '-') + '-' + uid());
      const novo = { 
        ...form, 
        custoUnitario: Number(form.custoUnitario), 
        estoque: Number(form.estoque), 
        id: novoId 
      };
      
      let novos;
      if(form.id) novos = insumos.map(i=> i.id===form.id ? novo : i);
      else novos = [...insumos, novo];
      
      salvarInsumos(novos);
      setForm({ id:null, nome:'', unidade:'un', custoUnitario:'', estoque:'' });
    }

    function editar(i){ setForm({...i, custoUnitario: String(i.custoUnitario), estoque: String(i.estoque) }); }
    function excluir(i){ if(!confirm(`Excluir Insumo ${i.nome}?`)) return; salvarInsumos(insumos.filter(x=>x.id!==i.id)); }
    
    function adicionarEstoque(insumo) {
        const quantidade = prompt(`Quantas unidades/ml/g de ${insumo.nome} voc√™ est√° adicionando?`);
        if (quantidade && !isNaN(Number(quantidade)) && Number(quantidade) > 0) {
            const novosInsumos = insumos.map(i => i.id === insumo.id ? { ...i, estoque: i.estoque + Number(quantidade) } : i);
            salvarInsumos(novosInsumos);
        }
    }

    return (
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="bg-white p-4 rounded-2xl shadow">
          <h3 className="font-bold mb-3">{form.id ? 'Editar' : 'Novo'} Insumo (Mat√©ria-prima)</h3>
          <form onSubmit={submit} className="space-y-3">
            <input value={form.nome} onChange={e=>setForm({...form, nome:e.target.value})} placeholder="Nome do Insumo" className="w-full p-3 border rounded-xl" required />
            <select value={form.unidade} onChange={e=>setForm({...form, unidade:e.target.value})} className="w-full p-3 border rounded-xl" required>
                <option value="un">Unidade (un)</option>
                <option value="ml">Mililitro (ml)</option>
                <option value="g">Grama (g)</option>
                <option value="kg">Quilograma (kg)</option>
                <option value="l">Litro (l)</option>
            </select>
            <input value={form.custoUnitario} onChange={e=>setForm({...form, custoUnitario:e.target.value})} placeholder={`Custo por ${form.unidade}`} type="number" step="0.0001" className="w-full p-3 border rounded-xl" required />
            <input value={form.estoque} onChange={e=>setForm({...form, estoque:e.target.value})} placeholder="Estoque Atual" type="number" step="any" className="w-full p-3 border rounded-xl" required />

            <div className="flex gap-3">
              <button className="flex-1 py-3 bg-gradient-to-r from-terracota to-redBrown text-white rounded-xl font-semibold shadow">{form.id ? 'Atualizar' : 'Adicionar'}</button>
              {form.id && <button type="button" onClick={()=>setForm({ id:null, nome:'', unidade:'un', custoUnitario:'', estoque:'' })} className="py-3 px-4 border rounded-xl hover:bg-gray-100">Cancelar</button>}
            </div>
          </form>
        </div>

        <div className="lg:col-span-2 bg-white p-4 rounded-2xl shadow">
          <h3 className="font-bold mb-3">Estoque de Insumos</h3>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-gradient-to-r from-red-50 to-red-100">
                <tr>
                  <th className="p-3 text-left">Insumo</th>
                  <th className="p-3 text-left">Un.</th>
                  <th className="p-3 text-right">Custo/Un.</th>
                  <th className="p-3 text-right">Estoque</th>
                  <th className="p-3 text-center">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                {insumos.map(i=>(
                  <tr key={i.id} className="border-b hover:bg-gray-50">
                    <td className="p-3">{i.nome}</td>
                    <td className="p-3">{i.unidade}</td>
                    <td className="p-3 text-right text-green-600">{currency(i.custoUnitario)}</td>
                    <td className={`p-3 text-right ${i.estoque<=10 ? 'text-red-600 font-bold' : ''}`}>{i.estoque.toFixed(2)}</td>
                    <td className="p-3 text-center">
                      <div className="flex items-center justify-center gap-3">
                        <button onClick={()=>adicionarEstoque(i)} className="text-green-500 hover:underline">Repor</button>
                        <button onClick={()=>editar(i)} className="text-terracota hover:underline">Editar</button>
                        <button onClick={()=>excluir(i)} className="text-red-600 hover:underline">Excluir</button>
                    </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    );
  }
  
  // MODIFICADO: View para Relat√≥rio de Insumos/Custo agora em Tabela + Modal Detalhado
  function CustoInsumosView({ produtos, insumos }) {
      const [selectedProduto, setSelectedProduto] = useState(null);
      const insumosMap = insumos.reduce((map, i) => { map[i.id] = i; return map; }, {});
      
      const produtosComFicha = produtos.filter(p => p.fichaTecnica && p.fichaTecnica.length > 0);

      // Componente do Modal
      function FichaTecnicaModal({ produto, onClose }) {
        if (!produto) return null;
        
        const custoTotal = produto.custoProduto;
        const lucro = produto.preco - custoTotal;
        const margem = produto.preco > 0 ? (lucro / produto.preco) * 100 : 0;

        return (
            <div className="modal-overlay" onClick={onClose}>
                <div className="modal-content" onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-start mb-4 border-b pb-2">
                        <div className="flex items-center gap-3">
                             <div className="text-3xl">{produto.emoji}</div>
                             <div>
                                <h3 className="text-xl font-bold text-gray-800">{produto.nome}</h3>
                                <div className="text-sm text-gray-500">{produto.categoria}</div>
                             </div>
                        </div>
                        <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-4 mb-6">
                        <div className="bg-gray-50 p-3 rounded-lg text-center border">
                            <div className="text-xs text-gray-500 uppercase font-bold">Pre√ßo de Venda</div>
                            <div className="text-xl font-bold text-gray-800">{currency(produto.preco)}</div>
                        </div>
                        <div className="bg-red-50 p-3 rounded-lg text-center border border-red-100">
                            <div className="text-xs text-red-500 uppercase font-bold">Custo Total (CMV)</div>
                            <div className="text-xl font-bold text-red-700">{currency(custoTotal)}</div>
                        </div>
                        <div className="bg-green-50 p-3 rounded-lg text-center border border-green-100">
                            <div className="text-xs text-green-500 uppercase font-bold">Lucro Bruto</div>
                            <div className="text-xl font-bold text-green-700">{currency(lucro)}</div>
                        </div>
                        <div className="bg-blue-50 p-3 rounded-lg text-center border border-blue-100">
                            <div className="text-xs text-blue-500 uppercase font-bold">Margem (%)</div>
                            <div className="text-xl font-bold text-blue-700">{margem.toFixed(1)}%</div>
                        </div>
                    </div>
                    
                    <h4 className="font-bold text-gray-700 mb-3 border-b pb-1">Detalhamento dos Insumos</h4>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm mb-4">
                            <thead>
                                <tr className="bg-gray-100 text-left">
                                    <th className="p-2">Ingrediente</th>
                                    <th className="p-2 text-right">Qtd</th>
                                    <th className="p-2 text-right">Custo Un.</th>
                                    <th className="p-2 text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {produto.fichaTecnica.map((insumoRef, idx) => {
                                    const insumoData = insumosMap[insumoRef.idInsumo];
                                    const custoItem = insumoRef.quantidade * (insumoData?.custoUnitario || 0);
                                    
                                    return (
                                        <tr key={idx} className="border-b">
                                            <td className="p-2">{insumoData?.nome || 'Desconhecido'}</td>
                                            <td className="p-2 text-right">{insumoRef.quantidade} {insumoRef.unidade}</td>
                                            <td className="p-2 text-right text-gray-500">{currency(insumoData?.custoUnitario)}</td>
                                            <td className="p-2 text-right font-medium">{currency(custoItem)}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                    
                    <button onClick={onClose} className="w-full py-3 bg-terracota text-white rounded-xl font-bold hover:bg-redBrown transition">Fechar Ficha</button>
                </div>
            </div>
        );
      }

      return (
          <div className="space-y-6">
            <h2 className="text-3xl font-extrabold text-gray-800 border-b pb-2 flex items-center gap-3">
              <span className="text-4xl text-terracota">üìù</span> Relat√≥rio de Custos (Fichas T√©cnicas)
            </h2>

            <div className="bg-white rounded-2xl shadow overflow-hidden">
                <table className="w-full text-left border-collapse">
                    <thead className="bg-gray-100 text-gray-600 uppercase text-sm font-semibold">
                        <tr>
                            <th className="p-4">Produto</th>
                            <th className="p-4 hidden sm:table-cell">Categoria</th>
                            <th className="p-4 text-right">Pre√ßo Venda</th>
                            <th className="p-4 text-right text-red-600">Custo Total</th>
                            <th className="p-4 text-center">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                        {produtosComFicha.map(produto => (
                            <tr key={produto.id} className="hover:bg-gray-50 transition">
                                <td className="p-4 font-medium text-gray-800 flex items-center gap-2">
                                    <span className="text-xl">{produto.emoji}</span> {produto.nome}
                                </td>
                                <td className="p-4 text-gray-500 hidden sm:table-cell">{produto.categoria}</td>
                                <td className="p-4 text-right text-gray-800">{currency(produto.preco)}</td>
                                <td className="p-4 text-right font-bold text-red-600">{currency(produto.custoProduto)}</td>
                                <td className="p-4 text-center">
                                    <button 
                                        onClick={() => setSelectedProduto(produto)}
                                        className="bg-blue-100 text-blue-700 hover:bg-blue-200 px-4 py-2 rounded-lg text-sm font-bold transition"
                                    >
                                        Ver Ficha
                                    </button>
                                </td>
                            </tr>
                        ))}
                        {produtosComFicha.length === 0 && (
                            <tr><td colSpan="5" className="p-6 text-center text-gray-500">Nenhum produto com ficha t√©cnica cadastrada.</td></tr>
                        )}
                    </tbody>
                </table>
            </div>
            
            {/* Modal de Detalhes */}
            {selectedProduto && <FichaTecnicaModal produto={selectedProduto} onClose={() => setSelectedProduto(null)} />}
          </div>
      );
  }

  function PerdasView({ produtos, insumos, salvarPerdas, salvarInsumos, salvarProdutos }){
    const [tipo, setTipo] = useState('insumo');
    const [itemId, setItemId] = useState('');
    const [quantidade, setQuantidade] = useState('');
    const [justificativa, setJustificativa] = useState('');
    const [historico, setHistorico] = useState([]);
    
    useEffect(() => {
        setHistorico(storageGet('perdas', []));
    }, []); 

    const listaItens = tipo === 'insumo' ? insumos : produtos;
    const itemSelecionado = listaItens.find(i => i.id === itemId);

    function submit(e){
        e.preventDefault();
        if (!itemId || !quantidade || !justificativa) return alert('Preencha todos os campos.');
        const qtd = Number(quantidade);
        if (qtd <= 0) return alert('Quantidade deve ser positiva.');

        const itemBase = tipo === 'insumo' ? insumos.find(i => i.id === itemId) : produtos.find(p => p.id === itemId);
        if (!itemBase) return alert('Item n√£o encontrado.');
        
        if (itemBase.estoque < qtd) return alert(`Estoque insuficiente: Apenas ${itemBase.estoque.toFixed(2)} dispon√≠vel.`);

        const custoUnitario = tipo === 'insumo' ? itemBase.custoUnitario : itemBase.custoProduto || 0;
        
        const novaPerda = {
            id: uid(),
            data: new Date().toISOString(),
            tipo: tipo,
            itemNome: itemBase.nome,
            itemId: itemId,
            quantidade: qtd,
            custoUnitario: custoUnitario,
            custoTotal: qtd * custoUnitario,
            unidade: tipo === 'insumo' ? itemBase.unidade : 'un',
            justificativa: justificativa,
        };

        
        if (tipo === 'insumo') {
            salvarInsumos(insumos.map(i => i.id === itemId ? { ...i, estoque: i.estoque - qtd } : i));
        } else {
            const novosProdutos = produtos.map(p => p.id === itemId ? { ...p, estoque: p.estoque - qtd } : p);
            salvarProdutos(novosProdutos);
            
            if (itemBase.fichaTecnica) {
                 const carrinhoPerda = [{ id: itemId, quantidade: qtd, nome: itemBase.nome, preco: 0, custoProduto: itemBase.custoProduto || 0 }];
                 darBaixaInsumos(carrinhoPerda, produtos, insumos, salvarInsumos);
            }
        }

        const novoHistorico = [...historico, novaPerda];
        salvarPerdas(novoHistorico);
        setHistorico(novoHistorico);

        alert(`Perda de ${qtd}x ${itemBase.nome} registrada! Custo: ${currency(novaPerda.custoTotal)}`);
        setQuantidade('');
        setJustificativa('');
        setItemId('');
    }

    return (
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="bg-white p-4 rounded-2xl shadow lg:col-span-1">
          <h3 className="font-bold mb-3 text-red-700">‚ö†Ô∏è Registrar Nova Perda</h3>
          <form onSubmit={submit} className="space-y-3">
            <label className="block">
                <span className="text-sm text-gray-500">Tipo de Item</span>
                <select value={tipo} onChange={e=>setTipo(e.target.value)} className="w-full p-3 border rounded-xl" required>
                    <option value="insumo">Insumo (Ex: Garrafa de Cerveja, Lim√£o, Cacha√ßa)</option>
                    <option value="produto">Produto Acabado (Ex: Feijoada, Prato montado)</option>
                </select>
            </label>
            
            <label className="block">
                <span className="text-sm text-gray-500">Item Perdido</span>
                <select value={itemId} onChange={e=>setItemId(e.target.value)} className="w-full p-3 border rounded-xl" required>
                    <option value="">Selecione o Item</option>
                    {listaItens.map(i => <option key={i.id} value={i.id}>{i.nome}</option>)}
                </select>
            </label>
            
            <input value={quantidade} onChange={e=>setQuantidade(e.target.value)} placeholder={`Quantidade (${itemSelecionado?.unidade || 'un'})`} type="number" step="any" className="w-full p-3 border rounded-xl" required />
            <input value={justificativa} onChange={e=>setJustificativa(e.target.value)} placeholder="Justificativa (Ex: Garrafa quebrou, Lata inchou)" className="w-full p-3 border rounded-xl" required />

            <button className="w-full py-3 bg-red-500 text-white rounded-xl font-semibold shadow hover:bg-red-600">Registrar Perda</button>
          </form>
        </div>

        <div className="lg:col-span-2 bg-white p-4 rounded-2xl shadow">
          <h3 className="font-bold mb-3">Hist√≥rico de Perdas ({historico.length})</h3>
          <div className="overflow-x-auto max-h-96 overflow-y-auto">
            <table className="w-full text-sm">
              <thead className="bg-red-50 sticky top-0">
                <tr>
                  <th className="p-3 text-left">Data</th>
                  <th className="p-3 text-left">Item</th>
                  <th className="p-3 text-right">Custo</th>
                  <th className="p-3 text-left">Justificativa</th>
                </tr>
              </thead>
              <tbody>
                {historico.sort((a,b) => new Date(b.data) - new Date(a.data)).map(p=>(
                  <tr key={p.id} className="border-b hover:bg-red-50/50">
                    <td className="p-3 text-xs">{new Date(p.data).toLocaleString()}</td>
                    <td className="p-3">
                        <span className="font-semibold">{p.quantidade}x {p.itemNome}</span> 
                        <span className="text-xs text-gray-500"> ({p.tipo === 'insumo' ? 'Insumo' : 'Produto'})</span>
                    </td>
                    <td className="p-3 text-right text-red-600 font-bold">{currency(p.custoTotal)}</td>
                    <td className="p-3 text-xs italic">{p.justificativa}</td>
                </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
        </div>
    );
  }

  function RelatoriosView({ vendas, perdas }) {
    const areaRef = useRef(null);
    const lucroRef = useRef(null); 
    
    const series = useMemo(() => {
      const map = {};
      vendas.forEach(v => {
        const day = v.data.split('T')[0];
        map[day] = {
            receita: (map[day]?.receita || 0) + v.total,
            custo: (map[day]?.custo || 0) + (v.custoVenda || 0)
        };
      });
      const arr = Object.entries(map).map(([d, t]) => ({ 
          date: d, 
          receita: t.receita, 
          custo: t.custo, 
          lucro: t.receita - t.custo
      }));
      arr.sort((a, b) => a.date.localeCompare(b.date));
      return arr;
    }, [vendas]);
    
    const perdasSeries = useMemo(() => {
        const map = {};
        perdas.forEach(p => {
            const day = p.data.split('T')[0];
            map[day] = (map[day] || 0) + p.custoTotal;
        });
        const arr = Object.entries(map).map(([d, c]) => ({ date: d, custo: c }));
        arr.sort((a, b) => a.date.localeCompare(b.date));
        return arr;
    }, [perdas]);

    const top = useMemo(() => {
      const vendaMap = {};
      let totalUnidadesVendidas = 0; 

      vendas.forEach(v => {
        v.itens.forEach(it => {
          vendaMap[it.id] = vendaMap[it.id] || { nome: it.nome, quantidade: 0, total: 0, custo: 0 };
          vendaMap[it.id].quantidade += it.quantidade;
          vendaMap[it.id].total += it.preco * it.quantidade;
          vendaMap[it.id].custo += (it.custoUnitario || 0) * it.quantidade; 
          totalUnidadesVendidas += it.quantidade; 
        });
      });

      const topProdutosComDistribuicao = Object.values(vendaMap)
        .sort((a, b) => b.quantidade - a.quantidade)
        .slice(0, 6)
        .map(p => ({
          ...p,
          lucro: p.total - p.custo,
          distribuicao: totalUnidadesVendidas > 0 ? (p.quantidade / totalUnidadesVendidas) * 100 : 0
        }));
        
      return {
        list: topProdutosComDistribuicao,
        totalUnidades: totalUnidadesVendidas
      };
    }, [vendas]);

    useEffect(() => {
      if (areaRef.current && areaRef.current._chart) { try { areaRef.current._chart.destroy(); } catch { } }
      if (lucroRef.current && lucroRef.current._chart) { try { lucroRef.current._chart.destroy(); } catch { } }
      
      if (areaRef.current && series.length > 0) {
        const ctx = areaRef.current.getContext('2d');
        const labels = series.map(s => s.date.substring(5));
        const dataReceita = series.map(s => s.receita);
        areaRef.current._chart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [{ 
            label: 'Receita (R$)', data: dataReceita, fill: true, tension: 0.3, 
            borderColor: '#e4593c', 
            backgroundColor: 'rgba(228,89,60,0.12)'
          }] },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }
      
      if (lucroRef.current && series.length > 0) {
        const ctx = lucroRef.current.getContext('2d');
        const labels = series.map(s => s.date.substring(5));
        const dataLucro = series.map(s => s.lucro);
        const dataPerdas = perdasSeries.map(s => s.custo);
        lucroRef.current._chart = new Chart(ctx, {
          type: 'bar',
          data: { labels, datasets: [
            { label: 'Lucro', data: dataLucro, backgroundColor: '#059669' },
            { label: 'Perdas (Custo)', data: dataPerdas, backgroundColor: '#dc2626' }
          ] },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }
    }, [series, perdasSeries]);

    return (
      <div className="space-y-4">
        <h2 className="text-3xl font-extrabold text-gray-800 border-b pb-2">üìä Relat√≥rios</h2>
        
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div className="bg-white p-4 rounded-2xl shadow">
            <h4 className="font-bold mb-2">Receita por dia</h4>
            <div style={{ height: 240 }}>
              {series.length > 0 ? <canvas ref={areaRef}></canvas> : <div className="text-gray-500 text-center py-10">Sem dados</div>}
            </div>
          </div>
          
          <div className="bg-white p-4 rounded-2xl shadow">
            <h4 className="font-bold mb-2">Lucro e Perdas por dia</h4>
            <div style={{ height: 240 }}>
              {series.length > 0 || perdasSeries.length > 0 ? <canvas ref={lucroRef}></canvas> : <div className="text-gray-500 text-center py-10">Sem dados</div>}
            </div>
          </div>
          
        </div>
        
        <div className="bg-white p-4 rounded-2xl shadow">
            <h4 className="font-bold mb-3">Top 6 Produtos por Quantidade</h4>
            {top.list.length > 0 ? (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {top.list.map((p, i) => (
                  <div key={p.nome} className="text-sm bg-gray-50 p-3 rounded-lg border">
                    <div className="flex justify-between items-center mb-1">
                      <span className="font-bold text-lg">{i + 1}. {p.nome}</span>
                      <span className="font-semibold text-terracota">{p.distribuicao.toFixed(1)}%</span>
                    </div>
                    <div className="text-xs text-gray-600 mb-2">
                        Vendas: {currency(p.total)} | Custo: {currency(p.custo)} | Lucro: <b className="text-green-700">{currency(p.lucro)}</b>
                    </div>
                    <div className="mt-1 w-full bg-gray-200 rounded-full h-2">
                      <div className="h-2 rounded-full bg-gradient-to-r from-terracota to-redBrown" style={{ width: `${p.distribuicao}%` }}></div>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-gray-500 text-center py-6">Sem dados</div>
            )}
          </div>
      </div>
    );
  }

  function RelatorioAvancado({ vendas }) { 
    const [from, setFrom] = useState('');
    const [to, setTo] = useState('');
    const chartRef = useRef(null);

    const vendasFiltradas = useMemo(() => {
      let filtered = vendas;
      if (from) filtered = filtered.filter(v => v.data.split('T')[0] >= from);
      if (to) filtered = filtered.filter(v => v.data.split('T')[0] <= to);
      return filtered;
    }, [vendas, from, to]);

    const stats = useMemo(() => {
      const totalVendas = vendasFiltradas.length;
      const receitaTotal = vendasFiltradas.reduce((acc, v) => acc + v.total, 0);
      const custoTotal = vendasFiltradas.reduce((acc, v) => acc + (v.custoVenda || 0), 0);
      const lucroTotal = receitaTotal - custoTotal;
      const ticketMedio = totalVendas > 0 ? receitaTotal / totalVendas : 0;
      const margemLucro = receitaTotal > 0 ? (lucroTotal / receitaTotal) * 100 : 0;

      const productsSold = {};
      vendasFiltradas.forEach(v => {
        v.itens.forEach(item => {
          productsSold[item.id] = productsSold[item.id] || { nome: item.nome, quantidade: 0, total: 0, custo: 0 };
          productsSold[item.id].quantidade += item.quantidade;
          productsSold[item.id].total += item.preco * item.quantidade;
          productsSold[item.id].custo += (item.custoUnitario || 0) * item.quantidade; 
        });
      });

      const topProdutos = Object.values(productsSold).sort((a, b) => (b.total - b.custo) - (a.total - a.custo)).slice(0, 6);

      return { totalVendas, receitaTotal, custoTotal, lucroTotal, ticketMedio, margemLucro, topProdutos };
    }, [vendasFiltradas]);

    return (
      <div className="space-y-6">
        <h2 className="text-3xl font-extrabold text-gray-800 border-b pb-2">üìà Relat√≥rio Avan√ßado</h2>

        <div className="bg-white border p-4 rounded-2xl shadow">
          <h3 className="font-bold mb-3">Filtros</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label className="block">
              <span className="text-sm text-gray-500">Data Inicial</span>
              <input type="date" value={from} onChange={e => setFrom(e.target.value)} className="mt-1 block w-full p-3 border rounded-xl" />
            </label>
            <label className="block">
              <span className="text-sm text-gray-500">Data Final</span>
              <input type="date" value={to} onChange={e => setTo(e.target.value)} className="mt-1 block w-full p-3 border rounded-xl" />
            </label>
          </div>

          <div className="mt-6 grid grid-cols-5 gap-4">
            <div className="bg-gray-50 p-3 rounded-xl text-center">
              <div className="text-xs text-gray-500">Total Vendas</div>
              <div className="font-bold text-lg">{stats.totalVendas}</div>
            </div>
            <div className="bg-gray-50 p-3 rounded-xl text-center">
              <div className="text-xs text-gray-500">Receita Total</div>
              <div className="font-bold text-lg text-terracota">{currency(stats.receitaTotal)}</div>
            </div>
            <div className="bg-gray-50 p-3 rounded-xl text-center">
              <div className="text-xs text-gray-500">Custo Total</div>
              <div className="font-bold text-lg text-red-600">{currency(stats.custoTotal)}</div>
            </div>
            <div className="bg-gray-50 p-3 rounded-xl text-center">
              <div className="text-xs text-gray-500">Lucro Total</div>
              <div className="font-bold text-lg text-green-700">{currency(stats.lucroTotal)}</div>
            </div>
            <div className="bg-gray-50 p-3 rounded-xl text-center">
              <div className="text-xs text-gray-500">Ticket M√©dio (Lucro)</div>
              <div className="font-bold text-lg">{currency(stats.ticketMedio)} <span className="text-xs text-gray-400">({stats.margemLucro.toFixed(1)}%)</span></div>
            </div>
          </div>
          
          <h4 className="font-bold mt-6 mb-3 border-t pt-3">Top 6 Itens por Lucro no Per√≠odo</h4>
           <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-gradient-to-r from-red-50 to-red-100">
                <tr>
                  <th className="p-3 text-left">Produto</th>
                  <th className="p-3 text-right">Qtd. Vendida</th>
                  <th className="p-3 text-right">Receita</th>
                  <th className="p-3 text-right">Custo</th>
                  <th className="p-3 text-right">Lucro</th>
                </tr>
              </thead>
              <tbody>
                {stats.topProdutos.map(p=>(
                  <tr key={p.id} className="border-b hover:bg-gray-50">
                    <td className="p-3 font-semibold">{p.nome}</td>
                    <td className="p-3 text-right">{p.quantidade}</td>
                    <td className="p-3 text-right">{currency(p.total)}</td>
                    <td className="p-3 text-right text-red-600">{currency(p.custo)}</td>
                    <td className="p-3 text-right text-green-700 font-bold">{currency(p.total - p.custo)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    );
  }

  /****************
   * Main App *
   ****************/
  function App(){
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    
    const [produtos, setProdutos] = useState([]); 
    const [insumos, setInsumos] = useState([]); 
    const [perdas, setPerdas] = useState([]); 
    const [vendas, setVendas] = useState([]);
    const [pedidos, setPedidos] = useState([]);
    const [pedidosPendentesWeb, setPedidosPendentesWeb] = useState([]);
    
    const [carrinho, setCarrinho] = useState([]);
    const [busca, setBusca] = useState('');
    const [selected, setSelected] = useState('dashboard');
    
    // ------------------------------------
    // CARREGAMENTO E SINCRONIZA√á√ÉO INICIAL
    // ------------------------------------
    const loadData = () => {
        try {
            let ins = storageGet('insumos', initialInsumos);
            
            let prodsBase = getFlatMenu(cardapioData, ins);
            const prodsSalvos = storageGet('produtos', []);
            const prodsSalvosMap = prodsSalvos.reduce((map, p) => { map[p.id] = p; return map; }, {});
            
            let prodsFinais = prodsBase.map(p => {
                const pSalvo = prodsSalvosMap[p.id];
                return {
                    ...p,
                    estoque: pSalvo ? pSalvo.estoque : p.estoque,
                    manutencao: pSalvo ? pSalvo.manutencao : p.manutencao,
                };
            }).filter(p => !p.baseId || prodsSalvosMap[p.id] || p.id < 9999);

            storageSet('insumos', ins); 
            setInsumos(ins);

            storageSet('produtos', prodsFinais);
            setProdutos(prodsFinais);
            
            setVendas(storageGet('vendas', []));
            setPedidos(storageGet('pedidos', []));
            setPerdas(storageGet('perdas', [])); 
            setPedidosPendentesWeb(getPedidosWebPendentes()); 
        } catch(e) {
            console.error('Erro ao carregar dados do localStorage:', e);
            setInsumos(initialInsumos);
            setProdutos(initialProdutos);
        }
    };
    
    useEffect(() => {
        loadData();
        setLoading(false);
        
        const handleStorageChange = (e) => {
            if (e.key === 'pedidos_web_pendentes' || e.key === 'pedidos' || e.key === 'vendas') {
                loadData();
            }
        };

        window.addEventListener('storage', handleStorageChange);
        return () => {
            window.removeEventListener('storage', handleStorageChange);
        };
    }, []);
    
    // ------------------------------------
    // PERSIST√äNCIA 
    // ------------------------------------
    const salvarProdutos = (novos) => { setProdutos(novos); storageSet('produtos', novos); };
    const salvarInsumos = (novos) => { setInsumos(novos); storageSet('insumos', novos); };
    const salvarPerdas = (novos) => { setPerdas(novos); storageSet('perdas', novos); }; 
    const salvarVendas = (novos) => { setVendas(novos); storageSet('vendas', novos); };
    const salvarPedidos = (novos) => { setPedidos(novos); storageSet('pedidos', novos); };
    
    useEffect(() => { 
        if (!loading) { 
            storageSet('vendas', vendas);
        } 
    }, [vendas, loading]);
    
    useEffect(() => { 
        if (!loading) { 
            storageSet('pedidos', pedidos);
        } 
    }, [pedidos, loading]);
    
    // ------------------------------------
    // FLUXO PDV
    // ------------------------------------

    function adicionarAoCarrinho(produto){ 
      const itemExistente = carrinho.find(i=>i.id===produto.id);
      const produtoEmEstoque = produtos.find(p=>p.id===produto.id);
      
      if (produtoEmEstoque.manutencao) {
        alert(`${produto.nome} est√° em manuten√ß√£o.`);
        return;
      }

      if (produtoEmEstoque.estoque <= (itemExistente?.quantidade || 0)) {
        alert(`Estoque insuficiente para ${produto.nome}`);
        return;
      }

      if(itemExistente){
        setCarrinho(carrinho.map(i => i.id===produto.id ? {...i, quantidade: i.quantidade+1} : i));
      } else {
        setCarrinho([...carrinho, {...produto, quantidade:1}]);
      }
    }

    function alterarQuantidade(id, novaQuantidade){ 
      const produtoEmEstoque = produtos.find(p=>p.id===id);
      
      if(novaQuantidade <= 0) {
        removerDoCarrinho(id);
      } else if (novaQuantidade > produtoEmEstoque.estoque) {
        alert(`M√°ximo: ${produtoEmEstoque.estoque.toFixed(0)}`);
      } else {
        setCarrinho(carrinho.map(i=> i.id===id ? {...i, quantidade:novaQuantidade} : i));
      }
    }

    function removerDoCarrinho(id){ setCarrinho(carrinho.filter(i=>i.id!==id)); }

    function finalizarVenda(){
      if(carrinho.length === 0) return alert('Carrinho vazio!');
      const total = carrinho.reduce((s,i)=> s + i.preco * i.quantidade, 0);
      
      for (const item of carrinho) {
          const produtoEmEstoque = produtos.find(p => p.id === item.id);
          if (produtoEmEstoque.estoque < item.quantidade) {
              alert(`Falha no estoque: Apenas ${produtoEmEstoque.estoque.toFixed(0)} de ${item.nome} dispon√≠veis.`);
              return;
          }
      }
      
      const novosProdutos = produtos.map(produto => {
        const itemVendido = carrinho.find(item => item.id === produto.id);
        if(itemVendido) return {...produto, estoque: produto.estoque - itemVendido.quantidade};
        return produto;
      });
      salvarProdutos(novosProdutos);
      
      const custoVenda = darBaixaInsumos(carrinho, produtos, insumos, setInsumos);
      
      const itensVenda = carrinho.map(i => ({ 
            id: i.id, 
            nome: i.nome, 
            preco: i.preco, 
            quantidade: i.quantidade,
            custoUnitario: i.custoProduto || 0
      }));

      const novoPedido = {
        id: uid(),
        data: new Date().toISOString(),
        nomeCliente: 'Venda Direta',
        itens: itensVenda,
        total: total,
        status: 'Pendente', 
        tipo: 'Venda Direta',
        custoVenda: custoVenda 
      };
      
      setCarrinho([]);

      salvarPedidos([...pedidos, novoPedido]); 
      
      alert(`Venda Direta registrada e pedido enviado para Cozinha! Total: ${currency(total)}`);
    }
    
    function finalizarPedidoEGerarVenda(pedido) {
      if (!confirm(`Finalizar pedido de ${pedido.nomeCliente}?`)) return;

      const custoPedido = pedido.custoVenda || pedido.itens.reduce((sum, item) => sum + (item.custoUnitario || 0) * item.quantidade, 0);

      const novaVenda = {
        id: pedido.id,
        data: new Date().toISOString(),
        itens: pedido.itens.map(i => ({...i, custoUnitario: i.custoUnitario || 0})),
        total: pedido.total,
        custoVenda: custoPedido, 
        origem: `Pedido - ${pedido.nomeCliente}`
      };
      
      salvarVendas([...vendas, novaVenda]);

      salvarPedidos(pedidos.map(p => p.id === pedido.id ? { ...p, status: 'Vendido' } : p));
      
      alert(`Venda registrada! Total: ${currency(pedido.total)} | Lucro estimado: ${currency(pedido.total - custoPedido)}`);
    }

    const totalCarrinho = carrinho.reduce((s,i)=> s + i.preco * i.quantidade, 0);
    
    if(loading) return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-dark via-cinzaEscuro to-dark">
        <div className="text-center">
          <div className="text-6xl text-terracota mb-4">‚è≥</div>
          <div className="text-2xl text-terracota font-bold">Carregando LocalStorage...</div>
        </div>
      </div>
    );
    
    if(!user) return <Login onLogin={setUser} />;

    return (
      <div className="min-h-screen flex flex-col bg-slate-50">
        <Header user={user} onLogout={()=>setUser(null)} />
        <div className="flex flex-1 w-full overflow-hidden">
          <Sidebar selected={selected} setSelected={setSelected} totalPedidosWeb={pedidosPendentesWeb.length} user={user} onLogout={()=>setUser(null)} />
          <main className="flex-1 overflow-y-auto app-main-content">
            
            {selected === 'dashboard' && (
              <DashboardView 
                vendas={vendas} 
                perdas={perdas} 
                produtos={produtos} 
              />
            )}

            {selected === 'pdv' && (
              <PDVView produtos={produtos} adicionarAoCarrinho={adicionarAoCarrinho} busca={busca} setBusca={setBusca}
                     carrinho={carrinho} alterarQuantidade={alterarQuantidade} removerDoCarrinho={removerDoCarrinho}
                     finalizarVenda={finalizarVenda} totalCarrinho={totalCarrinho} />
            )}
            
            {selected === 'caixa_contas' && (
              <CaixaContasView 
                vendas={vendas}
                pedidos={pedidos}
                finalizarPedidoEGerarVenda={finalizarPedidoEGerarVenda}
              />
            )}

            {selected === 'pedidos_web' && (
              <PedidosWeb 
                pedidos={pedidos}
                setPedidos={salvarPedidos}
                pedidosPendentesWeb={pedidosPendentesWeb} 
                setPedidosPendentesWeb={setPedidosPendentesWeb}
                finalizarPedidoEGerarVenda={finalizarPedidoEGerarVenda}
              />
            )}
            
            {selected === 'produtos' && (
              <ProdutosView produtos={produtos} salvarProdutos={salvarProdutos} insumos={insumos} />
            )}
            
            {selected === 'insumos' && (
              <InsumosView insumos={insumos} salvarInsumos={salvarInsumos} />
            )}
            
            {selected === 'custo_insumos' && ( 
              <CustoInsumosView produtos={produtos} insumos={insumos} />
            )}
            
            {selected === 'perdas' && (
              <PerdasView 
                produtos={produtos} 
                insumos={insumos} 
                salvarPerdas={salvarPerdas} 
                salvarInsumos={salvarInsumos}
                salvarProdutos={salvarProdutos}
              />
            )}

            {selected === 'relatorios' && (
              <RelatoriosView vendas={vendas} perdas={perdas} produtos={produtos} />
            )}

            {selected === 'avancado' && (
              <RelatorioAvancado vendas={vendas} produtos={produtos} />
            )}
          </main>
        </div>
      </div>
    );
  }

  ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
