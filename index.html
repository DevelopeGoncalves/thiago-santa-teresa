<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-C9RLS2SDCJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-C9RLS2SDCJ');
  </script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDV - Thiago Santa Teresa (Custo e Ficha T√©cnica)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            terracota: '#e4593c',
            redBrown: '#a93131',
            dark: '#1a1a1a',
            cinzaEscuro: '#2d2d2d',
            cinzaClaroBg: '#f9fafb',
          }
        }
      }
    }
  </script>

  <style>
    body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .sidebar-scroll { max-height: calc(100vh - 96px); overflow:auto; }
    ::-webkit-scrollbar { width:10px; height:10px; }
    ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #e4593c, #a93131); border-radius:999px; }
    ::-webkit-scrollbar-track { background: transparent; }

    .logo-bar {
      width: 120px; height: 120px; margin: 0 auto; background: #1a1a1a;
      border-radius: 50%; border: 3px solid #e4593c;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 30px rgba(228, 89, 60, 0.5);
    }
    .logo-inner {
      width: 110px; height: 110px; border-radius: 50%; border: 2px solid #ffffff;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%); padding: 10px;
    }
    .logo-stars { display: flex; gap: 3px; margin-bottom: 5px; }
    .star { color: #e4593c; font-size: 11px; }
    .logo-text { text-align: center; }
    .logo-bar-text {
      font-size: 22px; font-weight: bold; color: #e4593c;
      letter-spacing: 2px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      line-height: 1;
    }
    .logo-do-gigante {
      font-size: 12px; font-weight: bold; color: #ffffff;
      margin-top: 3px; letter-spacing: 1px;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-cinzaClaroBg via-slate-50 to-cinzaClaroBg">

  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useMemo, useRef } = React;

  /**********************
   * CONFIGURA√á√ÉO FIREBASE *
   **********************/
  const firebaseConfig = {
  apiKey: "AIzaSyCB5k2sLKlSopQ5xes6e_1ctpXnHA2Pluo",
  authDomain: "bar-do-gigante.firebaseapp.com",
  databaseURL: "https://bar-do-gigante-default-rtdb.firebaseio.com",
  projectId: "bar-do-gigante",
  storageBucket: "bar-do-gigante.firebasestorage.app",
  messagingSenderId: "818575087702",
  appId: "1:818575087702:web:e488390c6f8ec6471b83f7"
};

  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.database();

  /**********************
   * Produtos & Insumos Base (ATUALIZADO CONFORME MENU ONLINE) *
   **********************/
   
  // 1. INSUMOS (Mat√©ria-prima) - Novo insumo 'gelo-un' adicionado
  const initialInsumos = [
      { id: 'cachaca-500', nome: 'Cacha√ßa (Garrafa)', unidade: 'ml', custoUnitario: 0.05, estoque: 10000, custoTotal: 500.00 }, // R$ 500/10000ml = R$ 0.05/ml
      { id: 'limao-un', nome: 'Lim√£o (Unidade)', unidade: 'un', custoUnitario: 0.50, estoque: 200 }, // R$ 0.50/un
      { id: 'acucar-g', nome: 'A√ß√∫car (Kg)', unidade: 'g', custoUnitario: 0.005, estoque: 5000 }, // R$ 5/Kg = R$ 0.005/g
      { id: 'gelo-un', nome: 'Gelo (Dose)', unidade: 'un', custoUnitario: 0.05, estoque: 500 }, // Novo insumo Gelo
      { id: 'cerveja-garrafa', nome: 'Cerveja (Garrafa 600ml)', unidade: 'un', custoUnitario: 5.50, estoque: 500 }, // R$ 5.50/un
      { id: 'refrigerante-lata', nome: 'Refrigerante (Lata 350ml)', unidade: 'un', custoUnitario: 3.50, estoque: 300 }, // R$ 3.50/un
      { id: 'torresmo-porcao', nome: 'Torresmo (Por√ß√£o P)', unidade: 'un', custoUnitario: 12.00, estoque: 100 },
  ];
   
  // 2. PRODUTOS COM FICHA T√âCNICA (Menu) - Dados espelhados do menu online
  const cardapioData = {
      bebidas: [
          { id: 1, nome: 'Cerveja Gelada', preco: 8.00, emoji: 'üç∫', categoria: 'Bebidas', 
              fichaTecnica: [ { idInsumo: 'cerveja-garrafa', quantidade: 1, unidade: 'un' } ] }, 
          { id: 2, nome: 'Refrigerante', preco: 6.00, emoji: 'ü•§', categoria: 'Bebidas',
              fichaTecnica: [ { idInsumo: 'refrigerante-lata', quantidade: 1, unidade: 'un' } ] },
          { id: 3, nome: '√Ågua com G√°s', preco: 4.00, emoji: 'üíß', categoria: 'Bebidas' },
          { id: 4, nome: '√Ågua sem G√°s', preco: 4.00, emoji: 'üíß', categoria: 'Bebidas' },
          { id: 5, nome: 'Suco Natural', preco: 10.00, emoji: 'üßÉ', categoria: 'Bebidas' },
      ],
      entradas: [
          { id: 6, nome: 'Torresmo Defumado', preco: 25.00, emoji: 'ü•ì', categoria: 'Entradas',
              fichaTecnica: [ { idInsumo: 'torresmo-porcao', quantidade: 1, unidade: 'un' } ] },
          { id: 7, nome: 'Cofrio', preco: 22.00, emoji: 'üçñ', categoria: 'Entradas' },
          { id: 8, nome: 'Franguinho', preco: 28.00, emoji: 'üçó', categoria: 'Entradas' },
          { id: 9, nome: 'F√≠gado', preco: 26.00, emoji: 'ü•©', categoria: 'Entradas' },
          { id: 10, nome: 'Caldos', preco: 18.00, emoji: 'üç≤', categoria: 'Entradas' },
          { id: 11, nome: 'P√£o com Lingui√ßa', preco: 20.00, emoji: 'üå≠', categoria: 'Entradas' },
          { id: 12, nome: 'Coxinha de Costela', preco: 24.00, emoji: 'ü•ü', categoria: 'Entradas' },
      ],
      pratos: [
          { id: 13, nome: 'Feijoada Completa', preco: 45.00, emoji: 'üçõ', categoria: 'Pratos Principais' },
          { id: 14, nome: 'Churrasco Premium', preco: 55.00, emoji: 'ü•©', categoria: 'Pratos Principais' },
          { id: 15, nome: 'Moqueca Capixaba', preco: 50.00, emoji: 'üêü', manutencao: true, categoria: 'Pratos Principais' },
      ],
      cocktails: [
          { id: 16, nome: 'Caipirinha', preco: 18.00, emoji: 'üçã', alcool: true, categoria: 'Cocktails',
              fichaTecnica: [ 
                  { idInsumo: 'cachaca-500', quantidade: 50, unidade: 'ml' }, // 50ml de cacha√ßa (R$ 2.50)
                  { idInsumo: 'limao-un', quantidade: 1, unidade: 'un' },       // 1 lim√£o (R$ 0.50)
                  { idInsumo: 'acucar-g', quantidade: 10, unidade: 'g' },       // 10g a√ß√∫car (R$ 0.05)
                  { idInsumo: 'gelo-un', quantidade: 3, unidade: 'un' }        // 3 doses de Gelo (R$ 0.15) - Custo total: R$ 3.20
              ] }, 
          { id: 17, nome: 'Fitzgerald', preco: 22.00, emoji: 'üç∏', alcool: true, categoria: 'Cocktails' },
          { id: 18, nome: 'Aperol Spritz', preco: 24.00, emoji: 'üçä', alcool: true, categoria: 'Cocktails' },
          { id: 19, nome: 'Tom Collins', preco: 20.00, emoji: 'üç∏', alcool: true, categoria: 'Cocktails' },
          { id: 20, nome: 'Penicillin', preco: 25.00, emoji: 'ü•É', alcool: true, categoria: 'Cocktails' },
          { id: 21, nome: 'Whisky Sour', preco: 26.00, emoji: 'ü•É', alcool: true, categoria: 'Cocktails' },
          { id: 22, nome: 'Daiquiri', preco: 21.00, emoji: 'üçπ', alcool: true, categoria: 'Cocktails' },
          { id: 23, nome: 'Moscow Mule', preco: 23.00, emoji: 'üç∫', alcool: true, categoria: 'Cocktails' },
          { id: 24, nome: 'Rabo de Galo', preco: 19.00, emoji: 'üç∏', alcool: true, categoria: 'Cocktails' },
      ],
      mocktails: [
          { id: 25, nome: 'Ginger Ale', preco: 14.00, emoji: 'ü•§', alcool: false, categoria: 'Mocktails' },
          { id: 26, nome: 'Pineapple Fresh', preco: 15.00, emoji: 'üçç', alcool: false, categoria: 'Mocktails' },
          { id: 27, nome: 'Morango Especial', preco: 15.00, emoji: 'üçì', alcool: false, categoria: 'Mocktails' },
      ],
      vinhos: [ // Agrupados
          { 
              id: 28, nome: 'Vinho Tinto', emoji: 'üç∑', categoria: 'Vinhos',
              opcoes: [
                  { id: 28.1, nomeOpcao: 'Ta√ßa', preco: 18.00 },
                  { id: 28.2, nomeOpcao: 'Garrafa', preco: 85.00 },
              ]
          },
          { 
              id: 29, nome: 'Vinho Branco', emoji: 'ü•Ç', categoria: 'Vinhos',
              opcoes: [
                  { id: 29.1, nomeOpcao: 'Ta√ßa', preco: 18.00 },
                  { id: 29.2, nomeOpcao: 'Garrafa', preco: 85.00 },
              ]
          },
          { 
              id: 30, nome: 'Espumante', emoji: 'üçæ', categoria: 'Vinhos',
              opcoes: [
                  { id: 30.1, nomeOpcao: 'Ta√ßa', preco: 20.00 },
                  { id: 30.2, nomeOpcao: 'Garrafa', preco: 95.00 },
              ]
          },
      ],
  };

  // Fun√ß√µes de formata√ß√£o e utilidades
  function uid(){ return Date.now() + Math.floor(Math.random()*9999); }
  function currency(v){ return 'R$ ' + Number(v||0).toFixed(2).replace('.', ','); }
  
  // Fun√ß√£o para calcular o custo total de um item
  function calcularCusto(item, insumosMap) {
      if (!item.fichaTecnica || item.fichaTecnica.length === 0) return 0;
      
      let custoTotal = 0;
      item.fichaTecnica.forEach(insumoRef => {
          const insumoData = insumosMap[insumoRef.idInsumo];
          if (insumoData) {
              custoTotal += insumoRef.quantidade * insumoData.custoUnitario;
          }
      });
      return custoTotal;
  }
  
  // Transforma o menu em lista plana e calcula o custo
  function getFlatMenu(menu, insumos) {
      const insumosMap = insumos.reduce((map, i) => { map[i.id] = i; return map; }, {});

      let flatItems = [];
      for (const category in menu) {
          menu[category].forEach(item => {
              // Usa placeholder se nenhuma URL for definida (pois n√£o h√° URL definida no PDV)
              const defaultImageUrl = `https://via.placeholder.com/400x150?text=${encodeURIComponent(item.nome.split(' ')[0])}`;
              const custo = calcularCusto(item, insumosMap); // Calcula o custo
              
              if (item.opcoes) {
                  item.opcoes.forEach(opcao => {
                      flatItems.push({
                          id: parseFloat(opcao.id),
                          nome: `${item.nome} (${opcao.nomeOpcao})`,
                          preco: opcao.preco,
                          emoji: item.emoji,
                          categoria: item.categoria,
                          estoque: 9999,
                          manutencao: item.manutencao || false,
                          baseId: item.id,
                          imagemUrl: defaultImageUrl,
                          custoProduto: custo, 
                          fichaTecnica: item.fichaTecnica 
                      });
                  });
              } else {
                  flatItems.push({ 
                    id: item.id, 
                    nome: item.nome, 
                    preco: item.preco, 
                    emoji: item.emoji, 
                    categoria: item.categoria,
                    estoque: item.manutencao ? 0 : 9999,
                    manutencao: item.manutencao || false,
                    imagemUrl: defaultImageUrl,
                    custoProduto: custo, 
                    fichaTecnica: item.fichaTecnica 
                  });
              }
          });
      }
      return flatItems;
  }
  
  const initialProdutosDefault = getFlatMenu(cardapioData, initialInsumos);
  
  const initialProdutos = initialProdutosDefault.map(p => ({
    ...p,
    estoque: p.manutencao ? 0 : p.estoque,
  }));
  
  // Fun√ß√µes para lidar com IDs de n√∫meros no Firebase (necess√°rio para vinhos)
  function prepareForFirebase(data) {
    if (Array.isArray(data)) {
        return data.map(item => {
            if (typeof item.id === 'number' || typeof item.id === 'string' && item.id.includes('.')) {
                // Converte IDs tipo 28.1 para '28-1' para o Firebase
                return { ...item, id: String(item.id).replace('.', '-') };
            }
            return item;
        });
    }
    return data;
  }
  
  function prepareFromFirebase(data) {
    if (Array.isArray(data)) {
        return data.map(item => ({
            // Converte IDs tipo '28-1' de volta para 28.1 para o React
            ...item,
            id: typeof item.id === 'string' && item.id.includes('-') ? parseFloat(item.id.replace('-', '.')) : item.id
        }));
    }
    return data;
  }
  
  /**********************
   * Utilit√°rios Firebase & LocalStorage *
   **********************/

  // Fun√ß√µes Firebase (substituem localStorage)
  async function storageGet(key, fallback=null){ 
    try {
      const snapshot = await db.ref(key).once('value');
      let data = snapshot.exists() ? snapshot.val() : fallback;
      if (key === 'produtos' && data) {
        data = prepareFromFirebase(data);
      } else if (key === 'insumos' && data) {
        data = Object.values(data); // Transforma o objeto em array (Firebase retorna objetos)
      } else if (key === 'perdas' && data) {
        data = Object.values(data);
      }
      return data;
    } catch(e){ 
      console.error('Erro ao ler Firebase:', e);
      return fallback; 
    }
  }

  async function storageSet(key, value){ 
    try {
      let dataToSet = value;
      if (key === 'produtos') {
        dataToSet = prepareForFirebase(value);
      } else if (key === 'insumos' || key === 'perdas') {
         // Para Insumos e Perdas, usaremos um map com o 'id' como chave para facilitar a atualiza√ß√£o.
         dataToSet = value.reduce((obj, item) => {
             obj[item.id] = item;
             return obj;
         }, {});
      }
      await db.ref(key).set(dataToSet);
    } catch(e){
      console.error('Erro ao salvar Firebase:', e);
    }
  }

  function storageWatch(key, callback) {
    db.ref(key).on('value', (snapshot) => {
      if (snapshot.exists()) {
        let data = snapshot.val();
        if (key === 'produtos') {
          data = prepareFromFirebase(data);
        } else if (key === 'insumos' || key === 'perdas') {
          data = Object.values(data);
        }
        callback(data);
      }
    });
  }
  
  function getPedidosWebPendentes() {
    try {
      const data = localStorage.getItem('pedidos_web_pendentes');
      return JSON.parse(data) || [];
    } catch (e) {
      console.error("Erro ao ler pedidos_web_pendentes do localStorage:", e);
      return [];
    }
  }

  function clearPedidosWebPendentes() {
    localStorage.removeItem('pedidos_web_pendentes');
  }
  
  /**********************
   * L√ìGICA DE CUSTO E ESTOQUE DE INSUMOS * **********************/
  
  function getCustoUnitarioItem(produto, insumosMap) {
      return calcularCusto(produto, insumosMap);
  }

  function darBaixaInsumos(carrinho, produtos, insumos, setInsumos) {
      // Cria um mapa mut√°vel dos insumos para dar baixa
      const insumosMap = insumos.reduce((map, i) => { map[i.id] = {...i}; return map; }, {});
      let custoTotalVenda = 0;

      for (const item of carrinho) {
          // Encontra a ficha t√©cnica no produto atualizado
          const produtoBase = produtos.find(p => p.id === item.id);
          if (!produtoBase || !produtoBase.fichaTecnica) continue;

          for (const insumoRef of produtoBase.fichaTecnica) {
              const insumoData = insumosMap[insumoRef.idInsumo];
              if (insumoData) {
                  // Quantidade a ser baixada (Qtd na Ficha * Qtd de Itens vendidos)
                  const quantidadeBaixa = insumoRef.quantidade * item.quantidade;
                  insumoData.estoque -= quantidadeBaixa;
                  
                  // Calcula o custo
                  custoTotalVenda += quantidadeBaixa * insumoData.custoUnitario;
              }
          }
      }
      
      const novosInsumos = Object.values(insumosMap);
      setInsumos(novosInsumos);
      return custoTotalVenda;
  }
  
  /**********
   * Login *
   **********/
  const defaultUser = { username: 'admin', password: '1234' };

  function Login({onLogin}){
    const [u, setU] = useState('');
    const [p, setP] = useState('');
    const [err, setErr] = useState('');

    function submit(e){
      e.preventDefault();
      if(u === defaultUser.username && p === defaultUser.password){
        onLogin({username: u});
      } else {
        setErr('Usu√°rio ou senha inv√°lidos');
      }
    }

    return (
      <div className="min-h-screen flex items-center justify-center p-6 bg-gradient-to-br from-dark via-cinzaEscuro to-dark">
        <div className="max-w-4xl w-full grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
          <div className="hidden md:flex flex-col items-center justify-center rounded-2xl p-8 bg-cinzaEscuro shadow-xl border-2 border-terracota">
            <div className="logo-bar mb-4">
              <div className="logo-inner">
                <div className="logo-stars">
                  <span className="star">‚òÖ</span>
                  <span className="star">‚òÖ</span>
                  <span className="star">‚òÖ</span>
                  <span className="star">‚òÖ</span>
                  <span className="star">‚òÖ</span>
                </div>
                <div className="logo-text">
                  <div className="logo-bar-text">THIAGO</div>
                  <div className="logo-do-gigante">SANTA TERESA</div>
                </div>
              </div>
            </div>
            <h1 className="text-3xl font-extrabold text-terracota">Thiago Santa Teresa</h1>
            <p className="mt-2 text-gray-300">Sistema de Ponto de Venda (PDV)</p>
            <div className="mt-6 text-sm text-gray-400">Dica: usu√°rio <b className="text-terracota">admin</b> / senha <b className="text-terracota">1234</b></div>
          </div>

          <form onSubmit={submit} className="bg-cinzaEscuro border-2 border-terracota rounded-2xl p-6 shadow-lg">
            <div className="flex items-center justify-between mb-6">
              <div>
                <h2 className="text-2xl font-bold text-terracota">Entrar</h2>
                <p className="text-sm text-gray-300">Acesse o sistema PDV</p>
              </div>
              <div className="text-2xl text-terracota">üîí</div>
              </div>

            <label className="block mb-4">
              <span className="text-sm text-gray-300">Usu√°rio</span>
              <input className="mt-1 block w-full p-3 border border-terracota bg-dark text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-terracota transition" value={u} onChange={e=>setU(e.target.value)} required />
            </label>

            <label className="block mb-4">
              <span className="text-sm text-gray-300">Senha</span>
              <input type="password" className="mt-1 block w-full p-3 border border-terracota bg-dark text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-terracota transition" value={p} onChange={e=>setP(e.target.value)} required />
            </label>

            {err && <div className="text-red-400 mb-3">{err}</div>}

            <button className="w-full py-3 rounded-xl font-bold bg-gradient-to-r from-terracota to-redBrown text-white shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition">Entrar</button>
          </form>
        </div>
      </div>
    );
  }

  /****************
   * Header, Side *
   ****************/
  function Header({user, onLogout}){
    return (
      <header className="bg-white shadow sticky top-0 z-30">
        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <div className="text-3xl text-terracota">üç∑</div>
            <div>
              <div className="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-terracota to-redBrown">Thiago Santa Teresa</div>
              <div className="text-xs text-gray-500 hidden sm:block">Sistema PDV (Firebase)</div>
            </div>
          </div>

          <div className="flex items-center gap-4">
            <div className="flex items-center gap-2 bg-gray-50 px-3 py-1 rounded-full shadow-sm">
              <div className="text-sm text-gray-700">üë§ {user?.username}</div>
            </div>
            <button onClick={onLogout} className="px-3 py-1 rounded-lg border hover:bg-terracota hover:text-white transition">Sair</button>
          </div>
        </div>
      </header>
    );
  }

  function Sidebar({selected, setSelected, totalPedidosWeb}){
    const itens = [
      { key:'pdv', label:'üõí PDV' },
      { key:'pedidos_web', label: `üåê Pedidos Web ${totalPedidosWeb > 0 ? `(${totalPedidosWeb})` : ''}` }, 
      { key:'pedidos', label:'üîî Pedidos (Cozinha)' },
      { key:'produtos', label:'üì¶ Produtos (Venda)' },
      { key:'insumos', label:'üß™ Insumos/Estoque' }, // Modificado
      { key:'custo_insumos', label:'üìù Relat√≥rio de Insumos' }, // Novo!
      { key:'perdas', label:'‚ö†Ô∏è Registro de Perdas' },
      { key:'relatorios', label:'üìä Relat√≥rios' },
      { key:'avancado', label:'üìà Relat√≥rio Avan√ßado' }
    ];
    return (
      <aside className="w-64 bg-white border-r hidden md:block">
        <div className="p-4 sidebar-scroll">
          {itens.map(i=>(
            <button key={i.key} onClick={()=>setSelected(i.key)}
              className={`flex items-center gap-3 w-full text-left px-4 py-4 rounded-xl my-1 text-lg font-medium transition ${selected===i.key ? 'bg-gradient-to-r from-terracota to-redBrown text-white shadow-lg' : 'hover:bg-red-50'}`}>
              <span>{i.label}</span>
            </button>
          ))}
        </div>
      </aside>
    );
  }

  /*********************
   * PDV *
   *********************/
  function PDVView({produtos, adicionarAoCarrinho, busca, setBusca, carrinho, alterarQuantidade, removerDoCarrinho, finalizarVenda, totalCarrinho}){
    const produtosFiltrados = produtos.filter(p => p.nome.toLowerCase().includes(busca.toLowerCase()) || p.categoria.toLowerCase().includes(busca.toLowerCase()));

    return (
      <div className="space-y-4">
        <div className="bg-white p-4 rounded-2xl shadow flex gap-3 items-center">
          <input value={busca} onChange={e=>setBusca(e.target.value)} placeholder="Pesquisar produto ou categoria" className="flex-1 p-3 border rounded-xl focus:ring-2 focus:ring-terracota transition" />
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2">
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {produtosFiltrados.map(produto => (
                <div key={produto.id}
                     onClick={()=>adicionarAoCarrinho(produto)}
                     className={`p-4 rounded-2xl border cursor-pointer shadow-sm hover:shadow-lg transform hover:-translate-y-1 transition bg-white ${produto.manutencao ? 'opacity-50 cursor-not-allowed border-red-400' : 'border-gray-200'}`}>
                  
                  {/* EXIBI√á√ÉO DA IMAGEM */}
                  {produto.imagemUrl ? (
                      <img src={produto.imagemUrl} alt={produto.nome} className="w-full h-24 object-cover rounded-xl mb-3" />
                  ) : (
                      <div className="w-full h-24 bg-gray-100 rounded-xl mb-3 flex items-center justify-center text-3xl">{produto.emoji}</div>
                  )}

                  <div className="flex items-start justify-between gap-3">
                    <div>
                      <div className="text-sm text-gray-500">{produto.categoria}</div>
                      <div className="font-semibold text-lg mt-1">{produto.nome}</div>
                      {produto.manutencao && <div className="text-xs text-red-500 font-bold mt-1">EM MANUTEN√á√ÉO</div>}
                    </div>
                    <div className="text-right">
                      <div className="text-terracota font-bold text-lg">{currency(produto.preco)}</div>
                      <div className="text-xs mt-2">
                        {produto.estoque <= 10 ? (
                          <span className="inline-flex items-center gap-2 px-2 py-1 rounded-full text-red-700 bg-red-50 text-xs font-semibold">‚ö†Ô∏è {produto.estoque}</span>
                        ) : (
                          <span className="inline-flex items-center gap-2 px-2 py-1 rounded-full text-gray-700 bg-gray-50 text-xs">üì¶ {produto.estoque}</span>
                        )}
                    </div>
                    </div>
                  </div>
                <div className="text-xs text-green-600">Custo/un: {currency(produto.custoProduto)}</div>
                </div>
              ))}
            </div>
          </div>

          <div className="bg-white p-4 rounded-2xl shadow h-full flex flex-col">
            <h3 className="font-bold text-lg flex items-center gap-2 text-terracota">üßæ Carrinho</h3>

            <div className="mt-3 flex-1 max-h-96 overflow-y-auto space-y-3">
              {carrinho.map(item=>(
                <div key={item.id} className="p-3 border rounded-lg">
                  <div className="flex items-start justify-between">
                    <div>
                      <div className="font-medium">{item.emoji} {item.nome}</div>
                      <div className="text-xs text-gray-500">{item.categoria}</div>
                    </div>
                    <div className="text-right">
                      <div className="font-semibold text-terracota">{currency(item.preco * item.quantidade)}</div>
                      {item.custoProduto > 0 && (
                        <div className="text-xs text-green-600">Custo: {currency(item.custoProduto * item.quantidade)}</div>
                      )}
                    </div>
                  </div>

                  <div className="mt-3 flex items-center gap-2">
                    <button onClick={()=>alterarQuantidade(item.id, item.quantidade - 1)} className="px-3 py-1 border rounded-lg hover:bg-red-50 transition">‚àí</button>
                    <div className="px-3">{item.quantidade}</div>
                    <button onClick={()=>alterarQuantidade(item.id, item.quantidade + 1)} className="px-3 py-1 border rounded-lg hover:bg-green-50 transition">+</button>
                    <button onClick={()=>removerDoCarrinho(item.id)} className="ml-auto text-red-600 hover:underline">Remover</button>
                  </div>
                </div>
              ))}

              {carrinho.length===0 && <div className="text-gray-500 text-center py-6">Carrinho vazio</div>}
            </div>

            <div className="mt-4 border-t pt-3">
              <div className="flex items-center justify-between font-bold text-lg mb-3">
                <div>Total</div>
                <div className="text-terracota">{currency(totalCarrinho)}</div>
              </div>
              
              <button onClick={finalizarVenda} 
                      disabled={carrinho.length === 0}
                      className="w-full py-3 rounded-xl font-bold bg-gradient-to-r from-green-500 to-teal-400 text-white shadow hover:shadow-lg transition disabled:opacity-50">
                Finalizar Venda Direta
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }
  
  // Removida ComandasView e l√≥gicas associadas
 
  function PedidosView({ pedidos, setPedidos, finalizarPedidoEGerarVenda }) {
    function alterarStatus(id, novoStatus) {
      const novosPedidos = pedidos.map(p => p.id === id ? { ...p, status: novoStatus } : p);
      setPedidos(novosPedidos);
    }
    
    // Pedidos agora s√≥ cont√©m Vendas Diretas e Web (sem Consumo Pr√©-pago)
    const pedidosPendentes = pedidos.filter(p => p.status === 'Pendente');
    const pedidosEmPreparo = pedidos.filter(p => p.status === 'Em Preparo');
    
    const pedidosFinalizados = pedidos.filter(p => p.status === 'Vendido');

    return (
      <div className="space-y-6">
        <h2 className="text-3xl font-extrabold text-gray-800 border-b pb-2 flex items-center gap-3">
          <span className="text-4xl text-terracota">üîî</span> Gest√£o de Pedidos (Cozinha)
          <span className="text-xs text-gray-500">(PDV e Web)</span>
        </h2>
        
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="p-4 rounded-2xl shadow border border-red-200 bg-red-50">
            <h3 className="font-bold text-xl mb-4 text-red-700">NOVOS - {pedidosPendentes.length}</h3>
            <div className="space-y-4 max-h-[70vh] overflow-y-auto">
              {pedidosPendentes.map(p => (
                <div key={p.id} className="p-3 bg-white rounded-xl shadow-md border border-red-300">
                  <div className="font-bold text-lg text-red-600">{p.nomeCliente}</div>
                  <div className="text-xs text-gray-500 mb-2">Origem: {p.tipo}</div>
                  <ul className="list-disc list-inside text-sm mb-3 ml-3">
                    {p.itens.map(it => <li key={it.id}>{it.quantidade}x {it.nome}</li>)}
                  </ul>
                  <button onClick={() => alterarStatus(p.id, 'Em Preparo')} className="w-full mt-3 py-2 bg-terracota text-white rounded-lg hover:bg-redBrown">Iniciar</button>
                </div>
              ))}
              {pedidosPendentes.length === 0 && <div className="text-gray-500 text-center py-6">Nenhum novo</div>}
            </div>
          </div>

          <div className="p-4 rounded-2xl shadow border border-yellow-200 bg-yellow-50">
            <h3 className="font-bold text-xl mb-4 text-yellow-700">EM PREPARO - {pedidosEmPreparo.length}</h3>
            <div className="space-y-4 max-h-[70vh] overflow-y-auto">
              {pedidosEmPreparo.map(p => {
                return (
                  <div key={p.id} className={`p-3 bg-white rounded-xl shadow-md border border-yellow-300`}>
                    <div className={`font-bold text-xl text-yellow-600`}>
                      {p.nomeCliente}
                    </div>
                  <div className="text-xs text-gray-500 mb-2">Origem: {p.tipo}</div>
                    <ul className="list-disc list-inside text-sm mb-3 ml-3">
                      {p.itens.map(it => <li key={it.id}>{it.quantidade}x {it.nome}</li>)}
                    </ul>
                    <div className="font-bold text-lg">{currency(p.total)}</div>
                    
                    <button 
                      onClick={() => finalizarPedidoEGerarVenda(p)} 
                      className="w-full mt-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"
                    >
                      Finalizar Venda
                    </button>
                  </div>
                );
              })}
              {pedidosEmPreparo.length === 0 && <div className="text-gray-500 text-center py-6">Nenhum em preparo</div>}
            </div>
          </div>
          
          <div className="p-4 rounded-2xl shadow border border-green-200 bg-green-50">
            <h3 className="font-bold text-xl mb-4 text-green-700">FINALIZADOS - {pedidosFinalizados.length}</h3>
            <div className="space-y-4 max-h-[70vh] overflow-y-auto">
              {pedidosFinalizados.slice(0, 5).map(p => ( 
                <div key={p.id} className="p-3 bg-white rounded-xl shadow-md border border-green-300">
                  <div className="font-bold text-lg text-green-600">{p.nomeCliente}</div>
                  <div className="text-right font-bold text-lg">{currency(p.total)}</div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  }
  
  function PedidosWeb({ pedidosPendentesWeb, setPedidosPendentesWeb, setPedidos }) {
    function aceitarPedido(pedido) {
        if (!confirm(`Aceitar pedido de ${pedido.nomeCliente}?`)) return;

        const novoPedidoCozinha = {
            id: uid(),
            data: new Date().toISOString(),
            nomeCliente: pedido.nomeCliente,
            itens: pedido.itens,
            total: pedido.total,
            status: 'Pendente',
            tipo: 'Venda Web'
        };

        setPedidos(prevPedidos => [...prevPedidos, novoPedidoCozinha]);

        const novosWeb = pedidosPendentesWeb.filter(p => p.id !== pedido.id);
        setPedidosPendentesWeb(novosWeb);
        localStorage.setItem('pedidos_web_pendentes', JSON.stringify(novosWeb));
    }
    
    function rejeitarPedido(pedido) {
        if (!confirm(`Rejeitar pedido de ${pedido.nomeCliente}? Isso ir√° remov√™-lo.`)) return;
        
        const novosWeb = pedidosPendentesWeb.filter(p => p.id !== pedido.id);
        setPedidosPendentesWeb(novosWeb);
        localStorage.setItem('pedidos_web_pendentes', JSON.stringify(novosWeb));
    }
    
    return (
      <div className="space-y-6">
        <h2 className="text-3xl font-extrabold text-gray-800 border-b pb-2 flex items-center gap-3">
          <span className="text-4xl text-terracota">üåê</span> Pedidos Recebidos da Web (Fila Local)
        </h2>
        
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {pedidosPendentesWeb.map(p => (
            <div key={p.id} className="p-4 rounded-2xl shadow-lg border-2 border-green-500 bg-green-50">
              <div className="flex justify-between items-center mb-2">
                <h3 className="font-bold text-xl text-green-700">{p.nomeCliente}</h3>
                <span className="text-sm bg-green-200 text-green-800 px-2 py-1 rounded-full">NOVO</span>
              </div>
              <p className="text-xs text-gray-500">Recebido em: {new Date(p.data).toLocaleTimeString()}</p>
              
              <div className="border-t pt-2 mt-2">
                <h4 className="font-bold text-lg mb-2 text-terracota">Itens:</h4>
                <ul className="list-disc list-inside text-sm mb-3 ml-3">
                  {p.itens.map(it => <li key={it.id}>{it.quantidade}x {it.nome}</li>)}
                </ul>
              </div>
              
              <div className="font-bold text-xl text-terracota mt-3">Total: {currency(p.total)}</div>
              
              <div className="mt-4 flex gap-3">
                <button 
                  onClick={() => aceitarPedido(p)}
                  className="flex-1 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-semibold"
                >
                  ‚úÖ Aceitar e Enviar Cozinha
                </button>
                <button 
                  onClick={() => rejeitarPedido(p)}
                  className="py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-semibold"
                >
                  ‚úï
                </button>
              </div>
            </div>
          ))}

          {pedidosPendentesWeb.length === 0 && (
            <div className="md:col-span-3 text-center text-gray-500 p-8 border rounded-xl bg-gray-50">Nenhum pedido web pendente.</div>
          )}
        </div>
      </div>
    );
  }

  function ProdutosView({produtos, salvarProdutos, insumos}){
    const [form, setForm] = useState({ id:null, nome:'', preco:'', estoque:'', categoria:'', imagemUrl:'', fichaTecnica: [] });
    const [insumoForm, setInsumoForm] = useState({ idInsumo: '', quantidade: '' });
    
    // Mapeia insumos para f√°cil acesso no formul√°rio
    const insumosMap = insumos.reduce((map, i) => { map[i.id] = i; return map; }, {});

    useEffect(() => {
        if(form.id) {
             const produtoParaEditar = produtos.find(p => p.id === form.id);
             setForm(p => ({ 
                 ...p, 
                 fichaTecnica: produtoParaEditar.fichaTecnica || [] 
             }));
        }
    }, [form.id]);

    function submit(e){
      e.preventDefault();
      if(!form.nome || !form.preco || !form.estoque) return alert('Preencha os campos obrigat√≥rios');
      
      const novoId = form.id || uid();
      const novo = { 
        ...form, 
        preco: Number(form.preco), 
        estoque: Number(form.estoque), 
        id: novoId 
      };
      
      // Recalcula o custo do produto com base na ficha t√©cnica atualizada
      novo.custoProduto = calcularCusto(novo, insumosMap);

      let novos;
      if(form.id) novos = produtos.map(p=> p.id===form.id ? novo : p);
      else novos = [...produtos, novo];
      
      salvarProdutos(novos);
      setForm({ id:null, nome:'', preco:'', estoque:'', categoria:'', imagemUrl:'', fichaTecnica: [] });
    }

    function editar(p){ setForm({...p, preco: String(p.preco), estoque: String(p.estoque), imagemUrl: p.imagemUrl || '', fichaTecnica: p.fichaTecnica || [] }); }
    function excluir(p){ if(!confirm(`Excluir ${p.nome}?`)) return; salvarProdutos(produtos.filter(x=>x.id!==p.id)); }
    
    function adicionarInsumo() {
        if (!insumoForm.idInsumo || !insumoForm.quantidade) return;
        const insumoExistente = form.fichaTecnica.find(i => i.idInsumo === insumoForm.idInsumo);
        if (insumoExistente) {
            alert("Insumo j√° adicionado. Edite a quantidade.");
            return;
        }
        
        const insumoData = insumosMap[insumoForm.idInsumo];

        setForm({
            ...form,
            fichaTecnica: [
                ...form.fichaTecnica,
                {
                    idInsumo: insumoForm.idInsumo,
                    quantidade: Number(insumoForm.quantidade),
                    unidade: insumoData.unidade,
                }
            ]
        });
        setInsumoForm({ idInsumo: '', quantidade: '' });
    }
    
    function removerInsumo(idInsumo) {
        setForm({
            ...form,
            fichaTecnica: form.fichaTecnica.filter(i => i.idInsumo !== idInsumo)
        });
    }


    return (
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="bg-white p-4 rounded-2xl shadow lg:col-span-1">
          <h3 className="font-bold mb-3">{form.id ? 'Editar' : 'Novo'} Produto</h3>
          <form onSubmit={submit} className="space-y-3">
            <input value={form.nome} onChange={e=>setForm({...form, nome:e.target.value})} placeholder="Nome" className="w-full p-3 border rounded-xl" required />
            <input value={form.preco} onChange={e=>setForm({...form, preco:e.target.value})} placeholder="Pre√ßo" type="number" step="0.01" className="w-full p-3 border rounded-xl" required />
            <input value={form.estoque} onChange={e=>setForm({...form, estoque:e.target.value})} placeholder="Estoque" type="number" className="w-full p-3 border rounded-xl" required />
            <input value={form.categoria} onChange={e=>setForm({...form, categoria:e.target.value})} placeholder="Categoria" className="w-full p-3 border rounded-xl" />
            
            <input value={form.imagemUrl} onChange={e=>setForm({...form, imagemUrl:e.target.value})} placeholder="URL da Imagem (opcional)" className="w-full p-3 border rounded-xl" />
            {form.imagemUrl && <img src={form.imagemUrl} alt="Preview" className="w-full h-24 object-cover rounded-xl mt-2" />}
            
            <div className="border-t pt-3 mt-4">
                <h4 className="font-bold text-sm mb-2 text-terracota">Ficha T√©cnica (Insumos/Receita)</h4>
                
                <div className="space-y-2 mb-3">
                    {form.fichaTecnica.map(item => (
                        <div key={item.idInsumo} className="flex justify-between items-center bg-gray-50 p-2 rounded-lg text-sm">
                            <span>{insumosMap[item.idInsumo]?.nome || 'Insumo Desconhecido'}</span>
                            <div className="flex items-center gap-2">
                                <span>{item.quantidade} {item.unidade}</span>
                                <button type="button" onClick={() => removerInsumo(item.idInsumo)} className="text-red-500 hover:text-red-700">x</button>
                            </div>
                        </div>
                    ))}
                </div>

                <div className="flex gap-2 mb-3">
                    <select value={insumoForm.idInsumo} onChange={e => setInsumoForm({...insumoForm, idInsumo: e.target.value})} className="flex-1 p-3 border rounded-xl">
                        <option value="">Selecione Insumo</option>
                        {insumos.map(i => <option key={i.id} value={i.id}>{i.nome} ({i.unidade})</option>)}
                    </select>
                    <input value={insumoForm.quantidade} onChange={e => setInsumoForm({...insumoForm, quantidade: e.target.value})} placeholder="Qtd" type="number" step="any" className="w-20 p-3 border rounded-xl" />
                    <button type="button" onClick={adicionarInsumo} className="px-4 py-3 bg-green-500 text-white rounded-xl">+</button>
                </div>
            </div>


            <div className="flex gap-3">
              <button className="flex-1 py-3 bg-gradient-to-r from-terracota to-redBrown text-white rounded-xl font-semibold shadow">{form.id ? 'Atualizar' : 'Adicionar'}</button>
              {form.id && <button type="button" onClick={()=>setForm({ id:null, nome:'', preco:'', estoque:'', categoria:'', imagemUrl:'', fichaTecnica:[] })} className="py-3 px-4 border rounded-xl hover:bg-gray-100">Cancelar</button>}
            </div>
          </form>
        </div>

        <div className="lg:col-span-2 bg-white p-4 rounded-2xl shadow">
          <h3 className="font-bold mb-3">Produtos de Venda</h3>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-gradient-to-r from-red-50 to-red-100">
                <tr>
                  <th className="p-3 text-left">Produto</th>
                  <th className="p-3 text-left">Categoria</th>
                  <th className="p-3 text-right">Pre√ßo</th>
                  <th className="p-3 text-right">Custo</th>
                  <th className="p-3 text-right">Estoque</th>
                  <th className="p-3 text-center">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                {produtos.map(p=>(
                  <tr key={p.id} className="border-b hover:bg-gray-50">
                    <td className="p-3">
                        {p.imagemUrl && <img src={p.imagemUrl} alt="" className="w-8 h-8 object-cover rounded-full inline mr-2" />}
                        {p.nome}
                    </td>
                    <td className="p-3">{p.categoria}</td>
                    <td className="p-3 text-right">{currency(p.preco)}</td>
                    <td className="p-3 text-right text-green-600">{currency(p.custoProduto)}</td>
                    <td className={`p-3 text-right ${p.estoque<=10 ? 'text-red-600 font-bold' : ''}`}>{p.estoque}</td>
                    <td className="p-3 text-center">
                      <div className="flex items-center justify-center gap-3">
                        <button onClick={()=>editar(p)} className="text-terracota hover:underline">Editar</button>
                        <button onClick={()=>excluir(p)} className="text-red-600 hover:underline">Excluir</button>
                    </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    );
  }
  
  // NOVO: View para gerenciar Insumos (Mat√©ria-prima)
  function InsumosView({ insumos, salvarInsumos }) {
    const [form, setForm] = useState({ id:null, nome:'', unidade:'un', custoUnitario:'', estoque:'' });

    function submit(e){
      e.preventDefault();
      if(!form.nome || !form.custoUnitario || !form.estoque) return alert('Preencha os campos obrigat√≥rios');
      
      const novoId = form.id || (form.nome.toLowerCase().replace(/\s/g, '-') + '-' + uid());
      const novo = { 
        ...form, 
        custoUnitario: Number(form.custoUnitario), 
        estoque: Number(form.estoque), 
        id: novoId 
      };
      
      let novos;
      if(form.id) novos = insumos.map(i=> i.id===form.id ? novo : i);
      else novos = [...insumos, novo];
      
      salvarInsumos(novos);
      setForm({ id:null, nome:'', unidade:'un', custoUnitario:'', estoque:'' });
    }

    function editar(i){ setForm({...i, custoUnitario: String(i.custoUnitario), estoque: String(i.estoque) }); }
    function excluir(i){ if(!confirm(`Excluir Insumo ${i.nome}?`)) return; salvarInsumos(insumos.filter(x=>x.id!==i.id)); }
    
    function adicionarEstoque(insumo) {
        const quantidade = prompt(`Quantas unidades/ml/g de ${insumo.nome} voc√™ est√° adicionando?`);
        if (quantidade && !isNaN(Number(quantidade)) && Number(quantidade) > 0) {
            const novosInsumos = insumos.map(i => i.id === insumo.id ? { ...i, estoque: i.estoque + Number(quantidade) } : i);
            salvarInsumos(novosInsumos);
        }
    }

    return (
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="bg-white p-4 rounded-2xl shadow">
          <h3 className="font-bold mb-3">{form.id ? 'Editar' : 'Novo'} Insumo (Mat√©ria-prima)</h3>
          <form onSubmit={submit} className="space-y-3">
            <input value={form.nome} onChange={e=>setForm({...form, nome:e.target.value})} placeholder="Nome do Insumo" className="w-full p-3 border rounded-xl" required />
            <select value={form.unidade} onChange={e=>setForm({...form, unidade:e.target.value})} className="w-full p-3 border rounded-xl" required>
                <option value="un">Unidade (un)</option>
                <option value="ml">Mililitro (ml)</option>
                <option value="g">Grama (g)</option>
                <option value="kg">Quilograma (kg)</option>
                <option value="l">Litro (l)</option>
            </select>
            <input value={form.custoUnitario} onChange={e=>setForm({...form, custoUnitario:e.target.value})} placeholder={`Custo por ${form.unidade}`} type="number" step="0.0001" className="w-full p-3 border rounded-xl" required />
            <input value={form.estoque} onChange={e=>setForm({...form, estoque:e.target.value})} placeholder="Estoque Atual" type="number" step="any" className="w-full p-3 border rounded-xl" required />

            <div className="flex gap-3">
              <button className="flex-1 py-3 bg-gradient-to-r from-terracota to-redBrown text-white rounded-xl font-semibold shadow">{form.id ? 'Atualizar' : 'Adicionar'}</button>
              {form.id && <button type="button" onClick={()=>setForm({ id:null, nome:'', unidade:'un', custoUnitario:'', estoque:'' })} className="py-3 px-4 border rounded-xl hover:bg-gray-100">Cancelar</button>}
            </div>
          </form>
        </div>

        <div className="lg:col-span-2 bg-white p-4 rounded-2xl shadow">
          <h3 className="font-bold mb-3">Estoque de Insumos</h3>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-gradient-to-r from-red-50 to-red-100">
                <tr>
                  <th className="p-3 text-left">Insumo</th>
                  <th className="p-3 text-left">Un.</th>
                  <th className="p-3 text-right">Custo/Un.</th>
                  <th className="p-3 text-right">Estoque</th>
                  <th className="p-3 text-center">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                {insumos.map(i=>(
                  <tr key={i.id} className="border-b hover:bg-gray-50">
                    <td className="p-3">{i.nome}</td>
                    <td className="p-3">{i.unidade}</td>
                    <td className="p-3 text-right text-green-600">{currency(i.custoUnitario)}</td>
                    <td className={`p-3 text-right ${i.estoque<=10 ? 'text-red-600 font-bold' : ''}`}>{i.estoque.toFixed(2)}</td>
                    <td className="p-3 text-center">
                      <div className="flex items-center justify-center gap-3">
                        <button onClick={()=>adicionarEstoque(i)} className="text-green-500 hover:underline">Repor</button>
                        <button onClick={()=>editar(i)} className="text-terracota hover:underline">Editar</button>
                        <button onClick={()=>excluir(i)} className="text-red-600 hover:underline">Excluir</button>
                    </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    );
  }
  
  // NOVO: View para Relat√≥rio de Insumos/Custo
  function CustoInsumosView({ produtos, insumos }) {
      const insumosMap = insumos.reduce((map, i) => { map[i.id] = i; return map; }, {});
      
      // Filtra apenas produtos que possuem ficha t√©cnica
      const produtosComFicha = produtos.filter(p => p.fichaTecnica && p.fichaTecnica.length > 0);

      return (
          <div className="space-y-6">
            <h2 className="text-3xl font-extrabold text-gray-800 border-b pb-2 flex items-center gap-3">
              <span className="text-4xl text-terracota">üìù</span> Relat√≥rio de Custo de Insumos por Produto
            </h2>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {produtosComFicha.map(produto => (
                  <div key={produto.id} className="bg-white p-4 rounded-2xl shadow-lg border border-gray-200">
                      <h3 className="font-bold text-xl mb-3 text-redBrown">{produto.emoji} {produto.nome}</h3>
                      <div className="flex justify-between font-bold text-lg border-b pb-2 mb-2">
                          <span className="text-gray-600">Pre√ßo Venda:</span>
                          <span className="text-terracota">{currency(produto.preco)}</span>
                      </div>
                      
                      <h4 className="font-semibold text-gray-700 mt-4 mb-2">Insumos (Ficha T√©cnica):</h4>
                      <div className="space-y-1 text-sm">
                          {produto.fichaTecnica.map(insumoRef => {
                              const insumoData = insumosMap[insumoRef.idInsumo];
                              if (!insumoData) return <div key={insumoRef.idInsumo} className="text-red-500">Insumo Desconhecido!</div>;
                              
                              const custoItem = insumoRef.quantidade * insumoData.custoUnitario;
                              
                              return (
                                  <div key={insumoRef.idInsumo} className="flex justify-between py-1 border-b border-dashed">
                                      <span className="text-gray-600">
                                          {insumoRef.quantidade}{insumoRef.unidade} de <b className="font-medium">{insumoData.nome}</b>
                                      </span>
                                      <span className="font-semibold text-green-700">
                                          {currency(custoItem)}
                                      </span>
                                  </div>
                          );
                         })}
                      </div>

                      <div className="flex justify-between font-bold text-xl mt-4 pt-2 border-t border-terracota">
                          <span className="text-green-800">CUSTO TOTAL:</span>
                          <span className="text-green-800">{currency(produto.custoProduto)}</span>
                      </div>
                      <div className="flex justify-between font-bold text-lg mt-1">
                          <span className="text-blue-800">LUCRO BRUTO:</span>
                          <span className="text-blue-800">{currency(produto.preco - produto.custoProduto)}</span>
                      </div>
                  </div>
              ))}
            </div>
          </div>
      );
  }

  // NOVO: View para registrar perdas
  function PerdasView({ produtos, insumos, salvarPerdas, salvarInsumos, salvarProdutos }){
    const [tipo, setTipo] = useState('insumo'); // 'insumo' ou 'produto'
    const [itemId, setItemId] = useState('');
    const [quantidade, setQuantidade] = useState('');
    const [justificativa, setJustificativa] = useState('');
    const [historico, setHistorico] = useState([]);
    
    useEffect(() => {
        storageGet('perdas', []).then(setHistorico);
        storageWatch('perdas', setHistorico);
    }, []);

    const listaItens = tipo === 'insumo' ? insumos : produtos;
    const itemSelecionado = listaItens.find(i => i.id === itemId);

    function submit(e){
        e.preventDefault();
        if (!itemId || !quantidade || !justificativa) return alert('Preencha todos os campos.');
        const qtd = Number(quantidade);
        if (qtd <= 0) return alert('Quantidade deve ser positiva.');

        const itemBase = tipo === 'insumo' ? insumos.find(i => i.id === itemId) : produtos.find(p => p.id === itemId);
        if (!itemBase) return alert('Item n√£o encontrado.');
        
        if (itemBase.estoque < qtd) return alert(`Estoque insuficiente: Apenas ${itemBase.estoque} dispon√≠vel.`);

        const custoUnitario = tipo === 'insumo' ? itemBase.custoUnitario : itemBase.custoProduto || 0;
        
        const novaPerda = {
            id: uid(),
            data: new Date().toISOString(),
            tipo: tipo,
            itemNome: itemBase.nome,
            itemId: itemId,
            quantidade: qtd,
            custoUnitario: custoUnitario,
            custoTotal: qtd * custoUnitario,
            unidade: tipo === 'insumo' ? itemBase.unidade : 'un',
            justificativa: justificativa,
        };

        // 1. Dar baixa no estoque e registrar a perda no hist√≥rico
        
        if (tipo === 'insumo') {
            // Se for insumo, baixa apenas o insumo
            salvarInsumos(insumos.map(i => i.id === itemId ? { ...i, estoque: i.estoque - qtd } : i));
        } else {
            // Se for produto, baixa o estoque do produto...
            const novosProdutos = produtos.map(p => p.id === itemId ? { ...p, estoque: p.estoque - qtd } : p);
            salvarProdutos(novosProdutos);
            
            // ...e tamb√©m os insumos utilizados para "fazer" esse produto, simulando a perda da receita
            if (itemBase.fichaTecnica) {
                 const carrinhoPerda = [{ id: itemId, quantidade: qtd, nome: itemBase.nome, preco: 0, custoProduto: itemBase.custoProduto || 0 }]; // Mock
                 darBaixaInsumos(carrinhoPerda, produtos, insumos, salvarInsumos);
            }
        }

        // 2. Registrar a perda
        salvarPerdas([...historico, novaPerda]);

        alert(`Perda de ${qtd}x ${itemBase.nome} registrada! Custo: ${currency(novaPerda.custoTotal)}`);
        setQuantidade('');
        setJustificativa('');
        setItemId('');
    }

    return (
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="bg-white p-4 rounded-2xl shadow lg:col-span-1">
          <h3 className="font-bold mb-3 text-red-700">‚ö†Ô∏è Registrar Nova Perda</h3>
          <form onSubmit={submit} className="space-y-3">
            <label className="block">
                <span className="text-sm text-gray-500">Tipo de Item</span>
                <select value={tipo} onChange={e=>setTipo(e.target.value)} className="w-full p-3 border rounded-xl" required>
                    <option value="insumo">Insumo (Ex: Garrafa de Cerveja, Lim√£o, Cacha√ßa)</option>
                    <option value="produto">Produto Acabado (Ex: Feijoada, Prato montado)</option>
                </select>
            </label>
            
            <label className="block">
                <span className="text-sm text-gray-500">Item Perdido</span>
                <select value={itemId} onChange={e=>setItemId(e.target.value)} className="w-full p-3 border rounded-xl" required>
                    <option value="">Selecione o Item</option>
                    {listaItens.map(i => <option key={i.id} value={i.id}>{i.nome}</option>)}
                </select>
            </label>
            
            <input value={quantidade} onChange={e=>setQuantidade(e.target.value)} placeholder={`Quantidade (${itemSelecionado?.unidade || 'un'})`} type="number" step="any" className="w-full p-3 border rounded-xl" required />
            <input value={justificativa} onChange={e=>setJustificativa(e.target.value)} placeholder="Justificativa (Ex: Garrafa quebrou, Lata inchou)" className="w-full p-3 border rounded-xl" required />

            <button className="w-full py-3 bg-red-500 text-white rounded-xl font-semibold shadow hover:bg-red-600">Registrar Perda</button>
          </form>
        </div>

        <div className="lg:col-span-2 bg-white p-4 rounded-2xl shadow">
          <h3 className="font-bold mb-3">Hist√≥rico de Perdas ({historico.length})</h3>
          <div className="overflow-x-auto max-h-96 overflow-y-auto">
            <table className="w-full text-sm">
              <thead className="bg-red-50 sticky top-0">
                <tr>
                  <th className="p-3 text-left">Data</th>
                  <th className="p-3 text-left">Item</th>
                  <th className="p-3 text-right">Custo</th>
                  <th className="p-3 text-left">Justificativa</th>
                </tr>
              </thead>
              <tbody>
                {historico.sort((a,b) => new Date(b.data) - new Date(a.data)).map(p=>(
                  <tr key={p.id} className="border-b hover:bg-red-50/50">
                    <td className="p-3 text-xs">{new Date(p.data).toLocaleString()}</td>
                    <td className="p-3">
                        <span className="font-semibold">{p.quantidade}x {p.itemNome}</span> 
                        <span className="text-xs text-gray-500"> ({p.tipo === 'insumo' ? 'Insumo' : 'Produto'})</span>
                    </td>
                    <td className="p-3 text-right text-red-600 font-bold">{currency(p.custoTotal)}</td>
                    <td className="p-3 text-xs italic">{p.justificativa}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
        </div>
    );
  }

  function RelatoriosView({ vendas, perdas }) {
    const areaRef = useRef(null);
    const lucroRef = useRef(null); 
    
    const series = useMemo(() => {
      const map = {};
      vendas.forEach(v => {
        const day = v.data.split('T')[0];
        map[day] = {
            receita: (map[day]?.receita || 0) + v.total,
            custo: (map[day]?.custo || 0) + (v.custoVenda || 0)
        };
      });
      const arr = Object.entries(map).map(([d, t]) => ({ 
          date: d, 
          receita: t.receita, 
          custo: t.custo, 
          lucro: t.receita - t.custo
      }));
      arr.sort((a, b) => a.date.localeCompare(b.date));
      return arr;
    }, [vendas]);
    
    const perdasSeries = useMemo(() => {
        const map = {};
        perdas.forEach(p => {
            const day = p.data.split('T')[0];
            map[day] = (map[day] || 0) + p.custoTotal;
        });
        const arr = Object.entries(map).map(([d, c]) => ({ date: d, custo: c }));
        arr.sort((a, b) => a.date.localeCompare(b.date));
        return arr;
    }, [perdas]);

    const top = useMemo(() => {
      const vendaMap = {};
      let totalUnidadesVendidas = 0; 

      vendas.forEach(v => {
        v.itens.forEach(it => {
          vendaMap[it.id] = vendaMap[it.id] || { nome: it.nome, quantidade: 0, total: 0, custo: 0 };
          vendaMap[it.id].quantidade += it.quantidade;
          vendaMap[it.id].total += it.preco * it.quantidade;
          vendaMap[it.id].custo += (it.custoUnitario || 0) * it.quantidade; 
          totalUnidadesVendidas += it.quantidade; 
        });
      });

      const topProdutosComDistribuicao = Object.values(vendaMap)
        .sort((a, b) => b.quantidade - a.quantidade)
        .slice(0, 6)
        .map(p => ({
          ...p,
          lucro: p.total - p.custo,
          distribuicao: totalUnidadesVendidas > 0 ? (p.quantidade / totalUnidadesVendidas) * 100 : 0
        }));
        
      return {
        list: topProdutosComDistribuicao,
        totalUnidades: totalUnidadesVendidas
      };
    }, [vendas]);

    useEffect(() => {
      if (areaRef.current && areaRef.current._chart) { try { areaRef.current._chart.destroy(); } catch { } }
      if (lucroRef.current && lucroRef.current._chart) { try { lucroRef.current._chart.destroy(); } catch { } }
      
      if (areaRef.current && series.length > 0) {
        const ctx = areaRef.current.getContext('2d');
        const labels = series.map(s => s.date.substring(5));
        const dataReceita = series.map(s => s.receita);
        areaRef.current._chart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [{ 
            label: 'Receita (R$)', data: dataReceita, fill: true, tension: 0.3, 
            borderColor: '#e4593c', 
            backgroundColor: 'rgba(228,89,60,0.12)'
          }] },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }
      
      if (lucroRef.current && series.length > 0) {
        const ctx = lucroRef.current.getContext('2d');
        const labels = series.map(s => s.date.substring(5));
        const dataLucro = series.map(s => s.lucro);
        const dataPerdas = perdasSeries.map(s => s.custo);
        lucroRef.current._chart = new Chart(ctx, {
          type: 'bar',
          data: { labels, datasets: [
            { label: 'Lucro', data: dataLucro, backgroundColor: '#059669' },
            { label: 'Perdas (Custo)', data: dataPerdas, backgroundColor: '#dc2626' }
          ] },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }
    }, [series, perdasSeries]);

    return (
      <div className="space-y-4">
        <h2 className="text-3xl font-extrabold text-gray-800 border-b pb-2">üìä Relat√≥rios</h2>
        
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div className="bg-white p-4 rounded-2xl shadow">
            <h4 className="font-bold mb-2">Receita por dia</h4>
            <div style={{ height: 240 }}>
              {series.length > 0 ? <canvas ref={areaRef}></canvas> : <div className="text-gray-500 text-center py-10">Sem dados</div>}
            </div>
          </div>
          
          <div className="bg-white p-4 rounded-2xl shadow">
            <h4 className="font-bold mb-2">Lucro e Perdas por dia</h4>
            <div style={{ height: 240 }}>
              {series.length > 0 || perdasSeries.length > 0 ? <canvas ref={lucroRef}></canvas> : <div className="text-gray-500 text-center py-10">Sem dados</div>}
            </div>
          </div>
          
        </div>
        
        <div className="bg-white p-4 rounded-2xl shadow">
            <h4 className="font-bold mb-3">Top 6 Produtos por Quantidade</h4>
            {top.list.length > 0 ? (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {top.list.map((p, i) => (
                  <div key={p.nome} className="text-sm bg-gray-50 p-3 rounded-lg border">
                    <div className="flex justify-between items-center mb-1">
                      <span className="font-bold text-lg">{i + 1}. {p.nome}</span>
                      <span className="font-semibold text-terracota">{p.distribuicao.toFixed(1)}%</span>
                    </div>
                    <div className="text-xs text-gray-600 mb-2">
                        Vendas: {currency(p.total)} | Custo: {currency(p.custo)} | Lucro: <b className="text-green-700">{currency(p.lucro)}</b>
                    </div>
                    <div className="mt-1 w-full bg-gray-200 rounded-full h-2">
                      <div className="h-2 rounded-full bg-gradient-to-r from-terracota to-redBrown" style={{ width: `${p.distribuicao}%` }}></div>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-gray-500 text-center py-6">Sem dados</div>
            )}
          </div>
      </div>
    );
  }

  function RelatorioAvancado({ vendas }) { 
    const [from, setFrom] = useState('');
    const [to, setTo] = useState('');
    const chartRef = useRef(null);

    const vendasFiltradas = useMemo(() => {
      let filtered = vendas;
      if (from) filtered = filtered.filter(v => v.data.split('T')[0] >= from);
      if (to) filtered = filtered.filter(v => v.data.split('T')[0] <= to);
      return filtered;
    }, [vendas, from, to]);

    const stats = useMemo(() => {
      const totalVendas = vendasFiltradas.length;
      const receitaTotal = vendasFiltradas.reduce((acc, v) => acc + v.total, 0);
      const custoTotal = vendasFiltradas.reduce((acc, v) => acc + (v.custoVenda || 0), 0);
      const lucroTotal = receitaTotal - custoTotal;
      const ticketMedio = totalVendas > 0 ? receitaTotal / totalVendas : 0;
      const margemLucro = receitaTotal > 0 ? (lucroTotal / receitaTotal) * 100 : 0;

      const productsSold = {};
      vendasFiltradas.forEach(v => {
        v.itens.forEach(item => {
          productsSold[item.id] = productsSold[item.id] || { nome: item.nome, quantidade: 0, total: 0, custo: 0 };
          productsSold[item.id].quantidade += item.quantidade;
          productsSold[item.id].total += item.preco * item.quantidade;
          productsSold[item.id].custo += (item.custoUnitario || 0) * item.quantidade; 
        });
      });

      const topProdutos = Object.values(productsSold).sort((a, b) => (b.total - b.custo) - (a.total - a.custo)).slice(0, 6); // Top por Lucro

      return { totalVendas, receitaTotal, custoTotal, lucroTotal, ticketMedio, margemLucro, topProdutos };
    }, [vendasFiltradas]);

    return (
      <div className="space-y-6">
        <h2 className="text-3xl font-extrabold text-gray-800 border-b pb-2">üìà Relat√≥rio Avan√ßado</h2>

        <div className="bg-white border p-4 rounded-2xl shadow">
          <h3 className="font-bold mb-3">Filtros</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label className="block">
              <span className="text-sm text-gray-500">Data Inicial</span>
              <input type="date" value={from} onChange={e => setFrom(e.target.value)} className="mt-1 block w-full p-3 border rounded-xl" />
            </label>
            <label className="block">
              <span className="text-sm text-gray-500">Data Final</span>
              <input type="date" value={to} onChange={e => setTo(e.target.value)} className="mt-1 block w-full p-3 border rounded-xl" />
            </label>
          </div>

          <div className="mt-6 grid grid-cols-5 gap-4">
            <div className="bg-gray-50 p-3 rounded-xl text-center">
              <div className="text-xs text-gray-500">Total Vendas</div>
              <div className="font-bold text-lg">{stats.totalVendas}</div>
            </div>
            <div className="bg-gray-50 p-3 rounded-xl text-center">
              <div className="text-xs text-gray-500">Receita Total</div>
              <div className="font-bold text-lg text-terracota">{currency(stats.receitaTotal)}</div>
            </div>
            <div className="bg-gray-50 p-3 rounded-xl text-center">
              <div className="text-xs text-gray-500">Custo Total</div>
              <div className="font-bold text-lg text-red-600">{currency(stats.custoTotal)}</div>
            </div>
            <div className="bg-gray-50 p-3 rounded-xl text-center">
              <div className="text-xs text-gray-500">Lucro Total</div>
              <div className="font-bold text-lg text-green-700">{currency(stats.lucroTotal)}</div>
            </div>
            <div className="bg-gray-50 p-3 rounded-xl text-center">
              <div className="text-xs text-gray-500">Ticket M√©dio (Lucro)</div>
              <div className="font-bold text-lg">{currency(stats.ticketMedio)} <span className="text-xs text-gray-400">({stats.margemLucro.toFixed(1)}%)</span></div>
            </div>
          </div>
          
          <h4 className="font-bold mt-6 mb-3 border-t pt-3">Top 6 Itens por Lucro no Per√≠odo</h4>
           <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-gradient-to-r from-red-50 to-red-100">
                <tr>
                  <th className="p-3 text-left">Produto</th>
                  <th className="p-3 text-right">Qtd. Vendida</th>
                  <th className="p-3 text-right">Receita</th>
                  <th className="p-3 text-right">Custo</th>
                  <th className="p-3 text-right">Lucro</th>
                </tr>
              </thead>
              <tbody>
                {stats.topProdutos.map(p=>(
                  <tr key={p.id} className="border-b hover:bg-gray-50">
                    <td className="p-3 font-semibold">{p.nome}</td>
                    <td className="p-3 text-right">{p.quantidade}</td>
                    <td className="p-3 text-right">{currency(p.total)}</td>
                    <td className="p-3 text-right text-red-600">{currency(p.custo)}</td>
                    <td className="p-3 text-right text-green-700 font-bold">{currency(p.total - p.custo)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    );
  }

  /****************
   * Main App *
   ****************/
  function App(){
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    
    const [produtos, setProdutos] = useState([]); 
    const [insumos, setInsumos] = useState([]); 
    const [perdas, setPerdas] = useState([]); 
    const [vendas, setVendas] = useState([]);
    const [pedidos, setPedidos] = useState([]);
    const [pedidosPendentesWeb, setPedidosPendentesWeb] = useState([]); 
    
    const [carrinho, setCarrinho] = useState([]);
    const [busca, setBusca] = useState('');
    const [selected, setSelected] = useState('pdv');

    useEffect(() => {
      async function initData() {
        try {
          // 1. Carregar/Inicializar Insumos
          let ins = await storageGet('insumos', null);
          if (!ins || ins.length === 0) {
            await storageSet('insumos', initialInsumos);
            ins = initialInsumos;
          }
          setInsumos(ins);
          
          // Mapeia insumos para calcular o custo dos produtos
          const insumosMap = ins.reduce((map, i) => { map[i.id] = i; return map; }, {});
          
          // 2. Calcular produtos com o custo correto dos insumos
          const produtosCalculados = getFlatMenu(cardapioData, ins);
          
          // 3. Carregar/Inicializar Produtos
          let prods = await storageGet('produtos', null);
          if (!prods || prods.length === 0) {
            await storageSet('produtos', produtosCalculados);
            prods = produtosCalculados;
          } else {
             // Atualiza apenas o campo custoProduto dos produtos carregados com o custo mais recente dos insumos
             prods = prods.map(p => ({
                 ...p,
                 custoProduto: getCustoUnitarioItem(p, insumosMap)
             }));
          }
          
          const vends = await storageGet('vendas', []);
          const peds = await storageGet('pedidos', []);
          const pers = await storageGet('perdas', []); 
          
          const webPends = getPedidosWebPendentes();

          setProdutos(prods);
          setVendas(vends);
          setPedidos(peds);
          setPerdas(pers); 
          setPedidosPendentesWeb(webPends); 
        } catch(e) {
          console.error('Erro ao carregar dados:', e);
          alert('Erro ao conectar com Firebase. Verifique as credenciais!');
        } finally {
          setLoading(false);
        }
      }
      
      initData();
      
      storageWatch('pedidos', setPedidos);
      storageWatch('produtos', setProdutos);
      storageWatch('insumos', setInsumos); 
      storageWatch('perdas', setPerdas); 
      
      const handleStorageChange = (e) => {
        if (e.key === 'pedidos_web_pendentes') {
            setPedidosPendentesWeb(getPedidosWebPendentes());
        }
      };

      window.addEventListener('storage', handleStorageChange);
      
      return () => {
        db.ref('pedidos').off();
        db.ref('produtos').off();
        db.ref('insumos').off();
        db.ref('perdas').off();
        window.removeEventListener('storage', handleStorageChange);
      };
    }, []);
    
    // Auto-save useEffects
    useEffect(() => { if (!loading && produtos.length > 0) storageSet('produtos', produtos); }, [produtos, loading]);
    useEffect(() => { if (!loading) storageSet('vendas', vendas); }, [vendas, loading]);
    useEffect(() => { if (!loading) storageSet('pedidos', pedidos); }, [pedidos, loading]);
    useEffect(() => { if (!loading && insumos.length > 0) storageSet('insumos', insumos); }, [insumos, loading]); 
    useEffect(() => { if (!loading) storageSet('perdas', perdas); }, [perdas, loading]); 

    const salvarProdutos = (novos) => setProdutos(novos);
    const salvarInsumos = (novos) => setInsumos(novos); 
    const salvarPerdas = (novos) => setPerdas(novos); 

    function adicionarAoCarrinho(produto){ 
      const itemExistente = carrinho.find(i=>i.id===produto.id);
      const produtoEmEstoque = produtos.find(p=>p.id===produto.id);
      
      if (produtoEmEstoque.manutencao) {
        alert(`${produto.nome} est√° em manuten√ß√£o.`);
        return;
      }

      if (produtoEmEstoque.estoque <= (itemExistente?.quantidade || 0)) {
        alert(`Estoque insuficiente para ${produto.nome}`);
        return;
      }

      if(itemExistente){
        setCarrinho(carrinho.map(i => i.id===produto.id ? {...i, quantidade: i.quantidade+1} : i));
      } else {
        setCarrinho([...carrinho, {...produto, quantidade:1}]);
      }
    }

    function alterarQuantidade(id, novaQuantidade){ 
      const produtoEmEstoque = produtos.find(p=>p.id===id);
      
      if(novaQuantidade <= 0) {
        removerDoCarrinho(id);
      } else if (novaQuantidade > produtoEmEstoque.estoque) {
        alert(`M√°ximo: ${produtoEmEstoque.estoque}`);
      } else {
        setCarrinho(carrinho.map(i=> i.id===id ? {...i, quantidade:novaQuantidade} : i));
      }
    }

    function removerDoCarrinho(id){ setCarrinho(carrinho.filter(i=>i.id!==id)); }

    function finalizarVenda(){
      if(carrinho.length === 0) return alert('Carrinho vazio!');
      const total = carrinho.reduce((s,i)=> s + i.preco * i.quantidade, 0);
      
      for (const item of carrinho) {
          const produtoEmEstoque = produtos.find(p => p.id === item.id);
          if (produtoEmEstoque.estoque < item.quantidade) {
              alert(`Falha no estoque: Apenas ${produtoEmEstoque.estoque} de ${item.nome} dispon√≠veis.`);
              return;
          }
      }
      
      // 1. Dar baixa no estoque de PRODUTOS
      const novosProdutos = produtos.map(produto => {
        const itemVendido = carrinho.find(item => item.id === produto.id);
        if(itemVendido) return {...produto, estoque: produto.estoque - itemVendido.quantidade};
        return produto;
      });
      salvarProdutos(novosProdutos);
      
      // 2. Dar baixa no estoque de INSUMOS e calcular custo
      const custoVenda = darBaixaInsumos(carrinho, produtos, insumos, setInsumos);
      
      const venda = { 
        id: uid(), 
        data: new Date().toISOString(), 
        itens: carrinho.map(i => ({ 
            id: i.id, 
            nome: i.nome, 
            preco: i.preco, 
            quantidade: i.quantidade,
            custoUnitario: i.custoProduto || 0 // Adiciona o custo unit√°rio do produto no momento da venda
        })), 
        total: total,
        custoVenda: custoVenda, 
        origem: 'PDV Balc√£o' 
      };
      
      setVendas([...vendas, venda]);
      setCarrinho([]);

      // Novo: Gerar pedido para cozinha
      const novoPedido = {
        id: uid(),
        data: new Date().toISOString(),
        nomeCliente: 'Venda Direta',
        itens: venda.itens,
        total: venda.total,
        status: 'Pendente',
        tipo: 'Venda Direta'
      };
      setPedidos(prevPedidos => [...prevPedidos, novoPedido]);

      alert(`Venda finalizada! Total: ${currency(total)} | Custo Estimado: ${currency(custoVenda)}`);
    }
    
    // Fun√ß√£o para abrir comanda removida.
    
    function finalizarPedidoEGerarVenda(pedido) {
      if (!confirm(`Finalizar pedido de ${pedido.nomeCliente}?`)) return;

      const custoPedido = pedido.itens.reduce((sum, item) => sum + (item.custoUnitario || 0) * item.quantidade, 0);

      const novaVenda = {
        id: pedido.id,
        data: new Date().toISOString(),
        itens: pedido.itens,
        total: pedido.total,
        custoVenda: custoPedido, 
        origem: `Pedido - ${pedido.nomeCliente}`
      };
      
      // Aqui apenas registramos o pedido como vendido, a baixa de estoque j√° ocorreu
      
      setVendas([...vendas, novaVenda]);
      setPedidos(pedidos.map(p => p.id === pedido.id ? { ...p, status: 'Vendido' } : p));
      
      alert(`Venda registrada! Total: ${currency(pedido.total)} | Lucro estimado: ${currency(pedido.total - custoPedido)}`);
    }

    const totalCarrinho = carrinho.reduce((s,i)=> s + i.preco * i.quantidade, 0);
    
    if(loading) return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-dark via-cinzaEscuro to-dark">
        <div className="text-center">
          <div className="text-6xl text-terracota mb-4">‚è≥</div>
          <div className="text-2xl text-terracota font-bold">Carregando Firebase...</div>
        </div>
      </div>
    );
    
    if(!user) return <Login onLogin={setUser} />;

    return (
      <div className="min-h-screen flex flex-col bg-slate-50">
        <Header user={user} onLogout={()=>setUser(null)} />
        <div className="max-w-7xl mx-auto flex flex-1 w-full overflow-hidden">
          <Sidebar selected={selected} setSelected={setSelected} totalPedidosWeb={pedidosPendentesWeb.length} />
          <main className="flex-1 p-6 overflow-y-auto">
            <div className="flex items-center justify-between mb-6">
              <h1 className="text-2xl font-bold">Painel PDV - Thiago Santa Teresa</h1>
            </div>

            {selected === 'pdv' && (
              <PDVView produtos={produtos} adicionarAoCarrinho={adicionarAoCarrinho} busca={busca} setBusca={setBusca}
                     carrinho={carrinho} alterarQuantidade={alterarQuantidade} removerDoCarrinho={removerDoCarrinho}
                     finalizarVenda={finalizarVenda} totalCarrinho={totalCarrinho} />
            )}
            
            {selected === 'pedidos_web' && (
              <PedidosWeb 
                pedidosPendentesWeb={pedidosPendentesWeb} 
                setPedidosPendentesWeb={setPedidosPendentesWeb}
                setPedidos={setPedidos}
              />
            )}

            {selected === 'pedidos' && (
              <PedidosView pedidos={pedidos} setPedidos={setPedidos} 
                finalizarPedidoEGerarVenda={finalizarPedidoEGerarVenda} />
            )}
            
            {selected === 'produtos' && (
              <ProdutosView produtos={produtos} salvarProdutos={salvarProdutos} insumos={insumos} />
            )}
            
            {selected === 'insumos' && (
              <InsumosView insumos={insumos} salvarInsumos={salvarInsumos} />
            )}
            
            {selected === 'custo_insumos' && ( // NOVO RELAT√ìRIO
              <CustoInsumosView produtos={produtos} insumos={insumos} />
            )}
            
            {selected === 'perdas' && (
              <PerdasView 
                produtos={produtos} 
                insumos={insumos} 
                salvarPerdas={salvarPerdas} 
                salvarInsumos={salvarInsumos}
                salvarProdutos={salvarProdutos}
              />
            )}

            {selected === 'relatorios' && (
              <RelatoriosView vendas={vendas} perdas={perdas} produtos={produtos} />
            )}

            {selected === 'avancado' && (
              <RelatorioAvancado vendas={vendas} produtos={produtos} />
            )}
          </main>
        </div>
      </div>
    );
  }

  ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>

</html>

