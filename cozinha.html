<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thiago Santa Teresa - Central de Cozinha (Pedidos)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; background-color: #2d2d2d; }
    
    .kanban-column {
      min-height: 85vh;
      border-radius: 1rem;
      padding: 1rem;
      background: #1a1a1a;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .kanban-header {
      font-weight: bold;
      padding: 0.5rem 0;
      border-bottom: 2px solid;
      margin-bottom: 1rem;
      font-size: 1.25rem;
    }
    .card-pedido {
        background-color: #3b3b3b;
        color: #ffffff;
        border-radius: 0.75rem;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        transition: transform 0.2s;
    }
    .card-pedido:hover {
        transform: translateY(-2px);
    }
    .card-pedido-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #4a4a4a;
    }
    .card-pedido-title {
        font-weight: bold;
        font-size: 1.1rem;
        color: #e4593c; /* Terracota */
    }
    .card-pedido-tag {
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
        border-radius: 0.5rem;
    }
    .kanban-scroll {
        max-height: 75vh;
        overflow-y: auto;
    }
    
    /* Configura√ß√µes Tailwind customizadas do index.html */
    .text-terracota { color: #e4593c; }
    .bg-terracota { background-color: #e4593c; }
    .hover\:bg-redBrown:hover { background-color: #a93131; }

    ::-webkit-scrollbar { width:10px; height:10px; }
    ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #e4593c, #a93131); border-radius:999px; }
    ::-webkit-scrollbar-track { background: transparent; }
    
  </style>
</head>
<body>

  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect } = React;

  // Vari√°veis mockadas para compatibilidade (devem ser as mesmas do index.html)
  const initialInsumos = [
      { id: 'cachaca-500', nome: 'Cacha√ßa (Garrafa)', unidade: 'ml', custoUnitario: 0.05, estoque: 10000, custoTotal: 500.00 },
      { id: 'limao-un', nome: 'Lim√£o (Unidade)', unidade: 'un', custoUnitario: 0.50, estoque: 200 }, 
      { id: 'acucar-g', nome: 'A√ß√∫car (Kg)', unidade: 'g', custoUnitario: 0.005, estoque: 5000 }, 
      { id: 'gelo-un', nome: 'Gelo (Dose)', unidade: 'un', custoUnitario: 0.05, estoque: 500 },
      { id: 'cerveja-garrafa', nome: 'Cerveja (Garrafa 600ml)', unidade: 'un', custoUnitario: 5.50, estoque: 500 },
      { id: 'refrigerante-lata', nome: 'Refrigerante (Lata 350ml)', unidade: 'un', custoUnitario: 3.50, estoque: 300 },
      { id: 'torresmo-porcao', nome: 'Torresmo (Por√ß√£o P)', unidade: 'un', custoUnitario: 12.00, estoque: 100 },
  ];
  
  // Fun√ß√µes de Utilidade (copiadas do index.html)
  function uid(){ return Date.now() + Math.floor(Math.random()*9999); }
  function currency(v){ return 'R$ ' + Number(v||0).toFixed(2).replace('.', ','); }

  function prepareForStorage(data) {
    if (Array.isArray(data)) {
        return data.map(item => {
            if (typeof item.id === 'number' || typeof item.id === 'string' && item.id.includes('.')) {
                return { ...item, id: String(item.id).replace('.', '-') };
            }
            return item;
        });
    }
    return data;
  }
  
  function prepareFromStorage(data) {
    if (Array.isArray(data)) {
        return data.map(item => ({
            ...item,
            id: typeof item.id === 'string' && item.id.includes('-') ? parseFloat(item.id.replace('-', '.')) : item.id
        }));
    }
    return data;
  }
  
  function storageGet(key, fallback=null){ 
    try {
      const data = localStorage.getItem(key);
      if (data === null) return fallback;
      
      let parsedData = JSON.parse(data);
      
      if (key === 'produtos' && parsedData) {
        parsedData = prepareFromStorage(parsedData);
      }
      
      return parsedData;
    } catch(e){ 
      console.error('Erro ao ler localStorage:', e);
      return fallback; 
    }
  }

  function storageSet(key, value){ 
    try {
      let dataToSet = value;
      if (key === 'produtos') {
        dataToSet = prepareForStorage(value); 
      }
      localStorage.setItem(key, JSON.stringify(dataToSet));
    } catch(e){
      console.error('Erro ao salvar localStorage:', e);
    }
  }
  
  function getPedidosWebPendentes() {
    try {
      const data = localStorage.getItem('pedidos_web_pendentes');
      const webPedidos = JSON.parse(data) || [];
      return webPedidos.map(p => ({ 
        ...p, 
        tipo: 'Venda Web', 
        status: 'Novo - WEB', 
        id: p.id || uid(), 
        data: p.data || new Date().toISOString() 
      }));
    } catch (e) {
      console.error("Erro ao ler pedidos_web_pendentes do localStorage:", e);
      return [];
    }
  }

  // --- Fun√ß√µes de Estado Compartilhado (Para a Cozinha) ---

  const initialProdutosDefault = [
    // Mock limitado para dar baixa em insumos se necess√°rio
    { id: 1, nome: 'Cerveja Gelada', preco: 8.00, emoji: 'üç∫', categoria: 'Bebidas', custoProduto: 5.50, fichaTecnica: [ { idInsumo: 'cerveja-garrafa', quantidade: 1, unidade: 'un' } ] }, 
    { id: 2, nome: 'Refrigerante', preco: 6.00, emoji: 'ü•§', categoria: 'Bebidas', custoProduto: 3.50, fichaTecnica: [ { idInsumo: 'refrigerante-lata', quantidade: 1, unidade: 'un' } ] },
    { id: 6, nome: 'Torresmo Defumado', preco: 25.00, emoji: 'ü•ì', categoria: 'Entradas', custoProduto: 12.00, fichaTecnica: [ { idInsumo: 'torresmo-porcao', quantidade: 1, unidade: 'un' } ] },
    { id: 16, nome: 'Caipirinha', preco: 18.00, emoji: 'üçã', categoria: 'Cocktails', custoProduto: 3.20, fichaTecnica: [ 
        { idInsumo: 'cachaca-500', quantidade: 50, unidade: 'ml' }, 
        { idInsumo: 'limao-un', quantidade: 1, unidade: 'un' },       
        { idInsumo: 'acucar-g', quantidade: 10, unidade: 'g' },       
        { idInsumo: 'gelo-un', quantidade: 3, unidade: 'un' }        
    ] }, 
  ];

  function getFlatMenuMock(insumos) {
      const savedProducts = storageGet('produtos', initialProdutosDefault);
      return savedProducts.length > 0 ? savedProducts : initialProdutosDefault;
  }
  
  function darBaixaInsumos(carrinho, produtos, insumos, setInsumos) {
      const insumosMap = insumos.reduce((map, i) => { map[i.id] = {...i}; return map; }, {});
      let custoTotalVenda = 0;
      
      const produtosComFT = storageGet('produtos', getFlatMenuMock(insumos));
      
      for (const item of carrinho) {
          const produtoBase = produtosComFT.find(p => p.id === item.id);
          if (!produtoBase || !produtoBase.fichaTecnica) continue;

          for (const insumoRef of produtoBase.fichaTecnica) {
              const insumoData = insumosMap[insumoRef.idInsumo];
              if (insumoData) {
                  const quantidadeBaixa = insumoRef.quantidade * item.quantidade;
                  insumoData.estoque -= quantidadeBaixa;
                  custoTotalVenda += quantidadeBaixa * insumoData.custoUnitario;
              }
          }
      }
      
      const novosInsumos = Object.values(insumosMap);
      setInsumos(novosInsumos);
      return custoTotalVenda;
  }
  
  function salvarInsumos(novos) { storageSet('insumos', novos); }
  function salvarVendas(novos) { storageSet('vendas', novos); }
  function salvarPedidos(novos) { storageSet('pedidos', novos); }


  // --- Componente da Cozinha (Kanban) ---
  function CozinhaView() {
    
    // Estados independentes do Admin
    const [pedidos, setPedidos] = useState([]);
    const [pedidosPendentesWeb, setPedidosPendentesWeb] = useState([]);
    const [insumos, setInsumos] = useState(initialInsumos); 
    const [produtosMock, setProdutosMock] = useState(getFlatMenuMock(initialInsumos)); 

    const loadData = () => {
        setPedidos(storageGet('pedidos', []));
        setPedidosPendentesWeb(getPedidosWebPendentes());
        setInsumos(storageGet('insumos', initialInsumos));
        setProdutosMock(getFlatMenuMock(storageGet('insumos', initialInsumos)));
    };

    useEffect(() => {
        loadData();
        
        // Sincroniza√ß√£o em tempo real (a cada 5 segundos)
        const intervalId = setInterval(loadData, 5000); 

        // Event listener para mudan√ßas no Storage
        const handleStorageChange = (e) => {
            if (e.key === 'pedidos_web_pendentes' || e.key === 'pedidos') {
                loadData();
            }
        };
        window.addEventListener('storage', handleStorageChange);

        return () => {
            clearInterval(intervalId);
            window.removeEventListener('storage', handleStorageChange);
        };
    }, []);

    
    function aceitarPedido(pedido) {
        if (!confirm(`Aceitar pedido de ${pedido.nomeCliente} e envi√°-lo para a fila de preparo?`)) return;

        const novoPedidoCozinha = {
            id: uid(),
            data: new Date().toISOString(),
            nomeCliente: pedido.nomeCliente,
            itens: pedido.itens,
            total: pedido.total,
            status: 'Pendente', 
            tipo: 'Venda Web',
            itens: pedido.itens.map(item => {
                const produtoBase = produtosMock.find(p => p.id === item.id || String(p.id).replace('.', '-') === String(item.id));
                return { ...item, custoUnitario: produtoBase?.custoProduto || 0 };
            })
        };

        const novosPedidos = [...pedidos, novoPedidoCozinha];
        setPedidos(novosPedidos);
        salvarPedidos(novosPedidos);

        const novosWeb = pedidosPendentesWeb.filter(p => p.id !== pedido.id);
        setPedidosPendentesWeb(novosWeb);
        localStorage.setItem('pedidos_web_pendentes', JSON.stringify(novosWeb.map(p => ({
             id: p.id, data: p.data, nomeCliente: p.nomeCliente, itens: p.itens, total: p.total
        }))));
    }
    
    function rejeitarPedido(pedido) {
        if (!confirm(`Rejeitar pedido de ${pedido.nomeCliente}? Isso ir√° remov√™-lo da fila.`)) return;
        
        const novosWeb = pedidosPendentesWeb.filter(p => p.id !== pedido.id);
        setPedidosPendentesWeb(novosWeb);
        localStorage.setItem('pedidos_web_pendentes', JSON.stringify(novosWeb.map(p => ({
             id: p.id, data: p.data, nomeCliente: p.nomeCliente, itens: p.itens, total: p.total
        }))));
    }
    
    function alterarStatus(id, novoStatus) {
      const novosPedidos = pedidos.map(p => p.id === id ? { ...p, status: novoStatus } : p);
      setPedidos(novosPedidos);
      salvarPedidos(novosPedidos);
    }
    
    // FUN√á√ÉO CORRIGIDA - Agora muda o status para 'Pronto' e d√° baixa nos insumos (se for WEB)
    function finalizarPedidoEGerarVenda(pedido) {
      
      const custoPedido = pedido.custoVenda || pedido.itens.reduce((sum, item) => sum + (item.custoUnitario || 0) * item.quantidade, 0);

      // 1. Dar Baixa nos Insumos (Obrigat√≥rio para pedidos WEB que n√£o tiveram baixa pr√©via no PDV)
      // Pedidos do PDV j√° tem baixa de insumo e estoque de produto feita na fun√ß√£o `finalizarVenda` do index.html
      // Pedidos Web aceitos e iniciados na cozinha precisam ter a baixa de insumo feita aqui, pois o PDV s√≥ registra o pedido.
      if(pedido.tipo === 'Venda Web') {
         // O estoque de produtos n√£o precisa ser baixado aqui, pois no fluxo WEB o estoque n√£o √© gerenciado pelo cardapio.html
         // A baixa dos insumos deve ser feita aqui para o c√°lculo de CMV ser preciso.
         darBaixaInsumos(pedido.itens, produtosMock, insumos, salvarInsumos);
      }
      
      // 2. Mudar Status do Pedido para "PRONTO" e salvar
      const pedidosAtuais = storageGet('pedidos', []);
      const novosPedidos = pedidosAtuais.map(p => p.id === pedido.id ? { ...p, status: 'Pronto', custoVenda: custoPedido } : p);
      
      setPedidos(novosPedidos);
      salvarPedidos(novosPedidos);
      
      // Alerta CLARO para o Gar√ßom/Admin.
      alert(`üîî PEDIDO PRONTO: Chamar gar√ßom para entregar o pedido de ${pedido.nomeCliente}!`);
    }

    const pedidosWebEmFila = pedidosPendentesWeb;
    const pedidosPendentes = pedidos.filter(p => p.status === 'Pendente');
    const pedidosEmPreparo = pedidos.filter(p => p.status === 'Em Preparo');
    const pedidosProntos = pedidos.filter(p => p.status === 'Pronto'); // NOVO FILTRO
    

    return (
      <div className="p-6 h-screen">
        <header className="mb-6 pb-3 border-b border-gray-600 flex justify-between items-center">
            <h1 className="text-3xl font-extrabold text-terracota flex items-center gap-3">
                üç≥ Central de Cozinha
            </h1>
            <button 
                onClick={() => window.location.reload()} 
                className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition"
            >
                üîÑ Atualizar (For√ßar)
            </button>
        </header>
        
        {/* Kanban Board - Grid agora suporta 4 colunas de fluxo + 1 finalizados (se voc√™ quisesse 5) ou 4 no total */}
        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
          
          {/* COLUNA 1: NOVOS PEDIDOS (WEB EM FILA) */}
          <div className="kanban-column bg-red-900/10 border-2 border-red-700">
            <h3 className="kanban-header text-red-500 border-red-500">üì• NOVOS WEB ({pedidosWebEmFila.length})</h3>
            <div className="kanban-scroll space-y-4">
              {pedidosWebEmFila.map(p => (
                <div key={p.id} className="card-pedido border-2 border-green-500 bg-green-900/20">
                  <div className="card-pedido-header">
                      <span className="card-pedido-title text-green-400">{p.nomeCliente}</span>
                      <span className="card-pedido-tag bg-green-500 text-white">WEB</span>
                  </div>
                  <div className="text-xs text-gray-400 mb-2">Recebido: {new Date(p.data).toLocaleTimeString()}</div>
                  <ul className="list-disc list-inside text-sm mb-3 ml-3 text-gray-300">
                    {p.itens.map(it => <li key={it.id}>{it.quantidade}x {it.nome}</li>)}
                  </ul>
                  <div className="font-bold text-lg mb-3">{currency(p.total)}</div>

                  <div className="flex gap-2">
                    <button onClick={() => aceitarPedido(p)} className="flex-1 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">‚úÖ Aceitar</button>
                    <button onClick={() => rejeitarPedido(p)} className="py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700">‚úï</button>
                  </div>
                </div>
              ))}
              {pedidosWebEmFila.length === 0 && <div className="text-gray-500 text-center py-6">Nenhum novo pedido WEB</div>}
            </div>
          </div>

          {/* COLUNA 2: PENDENTES (ACEITOS) */}
          <div className="kanban-column bg-red-700/10 border-2 border-terracota">
            <h3 className="kanban-header text-terracota border-terracota">‚è≥ FILA DE PREPARO ({pedidosPendentes.length})</h3>
            <div className="kanban-scroll space-y-4">
              {pedidosPendentes.map(p => (
                <div key={p.id} className="card-pedido border-2 border-terracota">
                  <div className="card-pedido-header">
                    <span className="card-pedido-title">{p.nomeCliente}</span>
                    <span className={`card-pedido-tag ${p.tipo === 'Venda Direta' ? 'bg-blue-500' : 'bg-terracota'} text-white`}>{p.tipo === 'Venda Direta' ? 'PDV' : 'WEB ACEITO'}</span>
                  </div>
                  <div className="text-xs text-gray-400 mb-2">Inclus√£o: {new Date(p.data).toLocaleTimeString()}</div>
                  <ul className="list-disc list-inside text-sm mb-3 ml-3 text-gray-300">
                    {p.itens.map(it => <li key={it.id}>{it.quantidade}x {it.nome}</li>)}
                  </ul>
                  
                  <button onClick={() => alterarStatus(p.id, 'Em Preparo')} className="w-full mt-3 py-2 bg-terracota text-white rounded-lg hover:bg-redBrown">‚ñ∂ Iniciar Preparo</button>
                </div>
              ))}
              {pedidosPendentes.length === 0 && <div className="text-gray-500 text-center py-6">Fila de preparo vazia</div>}
            </div>
          </div>
          
          {/* COLUNA 3: EM PREPARO */}
          <div className="kanban-column bg-yellow-700/10 border-2 border-yellow-500">
            <h3 className="kanban-header text-yellow-500 border-yellow-500">üî™ EM PREPARO ({pedidosEmPreparo.length})</h3>
            <div className="kanban-scroll space-y-4">
              {pedidosEmPreparo.map(p => (
                <div key={p.id} className="card-pedido border-2 border-yellow-500 bg-yellow-900/20">
                  <div className="card-pedido-header">
                    <span className="card-pedido-title text-yellow-400">{p.nomeCliente}</span>
                    <span className={`card-pedido-tag ${p.tipo === 'Venda Direta' ? 'bg-blue-500' : 'bg-terracota'} text-white`}>{p.tipo === 'Venda Direta' ? 'PDV' : 'WEB'}</span>
                  </div>
                  <div className="text-xs text-gray-400 mb-2">Iniciado: {new Date(p.data).toLocaleTimeString()}</div>
                  <ul className="list-disc list-inside text-sm mb-3 ml-3 text-gray-300">
                    {p.itens.map(it => <li key={it.id}>{it.quantidade}x {it.nome}</li>)}
                  </ul>
                    
                  <button 
                    onClick={() => finalizarPedidoEGerarVenda(p)} 
                    className="w-full mt-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                  >
                    üîî Pronto! Chamar Gar√ßom
                  </button>
                </div>
              ))}
              {pedidosEmPreparo.length === 0 && <div className="text-gray-500 text-center py-6">Nenhum pedido em preparo</div>}
            </div>
          </div>
          
          {/* COLUNA 4: PRONTO/AGUARDANDO COBRAN√áA (NOVA COLUNA) */}
          <div className="kanban-column bg-green-700/10 border-2 border-green-500">
            <h3 className="kanban-header text-green-500 border-green-500">‚úÖ PRONTO ({pedidosProntos.length})</h3>
            <div className="kanban-scroll space-y-4">
              {pedidosProntos.map(p => ( 
                <div key={p.id} className="card-pedido opacity-90 bg-green-900/10 border-green-600">
                  <div className="card-pedido-header">
                      <span className="card-pedido-title text-green-500">{p.nomeCliente}</span>
                      <span className="text-xs text-gray-400">{new Date(p.data).toLocaleTimeString()}</span>
                  </div>
                  <div className="font-bold text-lg text-gray-300">{currency(p.total)}</div>
                  <ul className="list-disc list-inside text-sm mb-1 ml-3 text-gray-400">
                    {p.itens.map(it => <li key={it.id}>{it.quantidade}x {it.nome}</li>)}
                  </ul>
                  <div className="w-full mt-3 py-2 bg-green-600/50 text-white rounded-lg text-center font-bold">AGUARDANDO COBRAN√áA</div>
                </div>
              ))}
              {pedidosProntos.length === 0 && <div className="text-gray-500 text-center py-6">Nenhum pedido pronto</div>}
            </div>
          </div>
          
          {/* COLUNA 5: FINALIZADOS/VENDIDOS (√öltimos 10) - Opcional, mantida por compatibilidade */}
          {/* Para ver os finalizados, mantenha esta coluna ou verifique no index.html (Dashboard/Caixa) */}
          {/* Removida a coluna Finalizados para manter o layout 4-colunas-grid de fluxo */}
          
        </div>
      </div>
    );
  }

  ReactDOM.render(<CozinhaView />, document.getElementById('root'));
  </script>
</body>
</html>